(()=>{"use strict";var e={72:(e,t,i)=>{i.r(t),i.d(t,{SceneElement:()=>o});var s=i(199),n=i(480),a=i(361);class o{constructor(e,t){if(this.scale=1,this.bounceDuration=.3,this.bounceTimer=0,this.bounceStartScale=1,this.bounceEndScale=1,this.currentSpriteLoadId=0,this.id=e.id,this.type=e.type,this.position={x:e.x,y:e.y},this.size={x:e.width,y:e.height},this.properties=e.properties||{},this.resourceManager=t,this.sprite=null,this.spritePath=this.properties.sprite||null,this.isometricConverter=new s.K(32),this.interactable=e.interactable||!1,this.onClick=e.onClick||null,this.isConnectionTrigger=e.isConnectionTrigger||!1,this.connectionId=e.connectionId||null,this.sfx=e.sfx||null,this.triggers=e.triggers||null,this.scriptEngine=a.w.getInstance(),void 0!==e.zIndex)this.zIndex=e.zIndex;else switch(e.type){case"floor":this.zIndex=0;break;case"wall":this.zIndex=1;break;case"object":default:this.zIndex=2;break;case"character":this.zIndex=3}}async initialize(){this.spritePath&&(this.sprite=await this.resourceManager.loadImage(this.spritePath))}update(e){if(this.bounceTimer>0){this.bounceTimer-=e;const t=1-Math.max(this.bounceTimer,0)/this.bounceDuration;this.scale=this.bounceStartScale+(this.bounceEndScale-this.bounceStartScale)*t,this.bounceTimer<=0&&(this.scale=1)}}render(e,t){if(!this.sprite)return;const i=this.isometricConverter.tileToScreen(this.position.x,this.position.y),s=t.worldToScreen(i),n=t.getZoom();e.save(),e.translate(s.x,s.y),e.scale(this.scale*n,this.scale*n);const a=this.properties.blur;if(void 0!==a&&a>=0&&a<=1){const t=10*a;e.filter=`blur(${t}px)`}e.drawImage(this.sprite,-this.sprite.width/2,-this.sprite.height,this.sprite.width,this.sprite.height),e.restore()}getId(){return this.id}getType(){return this.type}getPosition(){return{...this.position}}setPosition(e){this.position={...e}}getSize(){return{...this.size}}setSize(e){this.size={...e}}getProperty(e){return this.properties[e]}setProperty(e,t){this.properties[e]=t}getProperties(){return{...this.properties}}setSprite(e){this.spritePath=e;const t=++this.currentSpriteLoadId;this.resourceManager.loadImage(e).then((e=>{t===this.currentSpriteLoadId&&(this.sprite=e)})).catch((t=>{console.error(`Failed to load sprite ${e} for element ${this.id}:`,t)}))}getSprite(){return this.sprite}setOnClick(e){this.onClick=e}isInteractable(){return this.interactable}async triggerInteraction(){this.bounceTimer=this.bounceDuration,this.bounceStartScale=1.2,this.bounceEndScale=1,this.scale=1.2,await this.executeScriptTrigger("click"),"function"==typeof this.onClick&&this.onClick();const e=this.getProperty("onClick");"function"==typeof e&&e(),this.handleContentTriggers();try{n.l.getInstance().emit("elementInteraction",{type:"elementInteraction",elementId:this.id,position:{...this.position}})}catch(e){console.error("Failed to emit element interaction event:",e)}}getZIndex(){return this.zIndex}setZIndex(e){this.zIndex=e}isSceneConnectionTrigger(){return this.isConnectionTrigger}getConnectionId(){return this.connectionId}setConnectionTrigger(e,t){this.isConnectionTrigger=e,t&&(this.connectionId=t)}getSfx(){return this.sfx}getClickSfx(){return this.sfx?.click||null}getHoverSfx(){return this.sfx?.hover||null}static incrementFrame(){o.frameCounter++}handleContentTriggers(){const e=this.getProperty("content");if(e)try{const t=n.l.getInstance();Array.isArray(e)?e.forEach((e=>this.processContentTrigger(e,t))):"object"==typeof e&&this.processContentTrigger(e,t)}catch(e){console.error(`Failed to process content triggers for element ${this.id}:`,e)}}processContentTrigger(e,t){if(!e.type||!e.id)return void console.warn(`Invalid content trigger for element ${this.id}:`,e);const i={action:e.action||"update",type:e.type,id:e.id,data:e.data||{},autoOpen:e.autoOpen};i.data.elementId=this.id,i.data.elementPosition={...this.position},t.emit("content",i),console.log(`ðŸ“‹ Content trigger fired: ${e.type}/${e.id} from element ${this.id}`)}async executeScriptTrigger(e){if(!this.triggers||!this.triggers[e])return;const t=this.triggers[e];if(Array.isArray(t)&&0!==t.length)try{await this.scriptEngine.executeActions(t,this.id)}catch(t){console.error(`Failed to execute script trigger ${e} for element ${this.id}:`,t)}}getTriggers(){return this.triggers}setTriggers(e){this.triggers=e}addTrigger(e,t){this.triggers||(this.triggers={}),this.triggers[e]=t}removeTrigger(e){this.triggers&&delete this.triggers[e]}hasTrigger(e){return!!(this.triggers&&this.triggers[e]&&this.triggers[e].length>0)}}o.frameCounter=0},159:(e,t,i)=>{i.d(t,{g:()=>o});class s{constructor(){this.masterVolume=1,this.musicVolume=.7,this.sfxVolume=.8,this.muted=!1,this.loadSettings()}getVolume(e){switch(e){case"master":return this.masterVolume;case"music":return this.musicVolume;case"sfx":return this.sfxVolume}}setVolume(e,t){switch(e){case"master":this.masterVolume=t;break;case"music":this.musicVolume=t;break;case"sfx":this.sfxVolume=t}this.saveSettings()}isMuted(){return this.muted}setMuted(e){this.muted=e,this.saveSettings()}saveSettings(){const e={masterVolume:this.masterVolume,musicVolume:this.musicVolume,sfxVolume:this.sfxVolume,muted:this.muted};localStorage.setItem("audioSettings",JSON.stringify(e))}loadSettings(){const e=localStorage.getItem("audioSettings");if(e){const t=JSON.parse(e);this.masterVolume=t.masterVolume??1,this.musicVolume=t.musicVolume??.7,this.sfxVolume=t.sfxVolume??.8,this.muted=t.muted??!1}}}class n{constructor(e,t,i,s){this.context=e,this.buffer=t,this.source=null,this.isPlaying=!1,this.isDisposed=!1,this.gainNode=e.createGain(),this.gainNode.connect(s),this.type=i}play(e={}){if(this.isDisposed)console.warn("Cannot play disposed AudioTrack");else{this.source&&this.stop();try{this.source=this.context.createBufferSource(),this.source.buffer=this.buffer,this.source.loop=e.loop??!1,this.source.addEventListener("ended",(()=>{this.isPlaying=!1,this.source&&(this.source.disconnect(),this.source=null)})),this.source.connect(this.gainNode),this.gainNode.gain.value=Math.max(0,Math.min(1,e.volume??1)),this.source.start(0),this.isPlaying=!0}catch(e){console.error("Failed to play audio track:",e),this.isPlaying=!1,this.source&&(this.source.disconnect(),this.source=null)}}}stop(){if(this.source)try{this.isPlaying&&this.source.stop(),this.source.disconnect()}catch(e){console.debug("Error stopping audio source (likely already stopped):",e)}finally{this.source=null,this.isPlaying=!1}}getType(){return this.type}setVolume(e){if(this.isDisposed)return void console.warn("Cannot set volume on disposed AudioTrack");const t=Math.max(0,Math.min(1,e));this.gainNode.gain.value=t}isCurrentlyPlaying(){return this.isPlaying&&null!==this.source}dispose(){if(!this.isDisposed){this.stop();try{this.gainNode.disconnect()}catch(e){console.debug("Error disconnecting gain node:",e)}this.isDisposed=!0}}}var a=i(480);class o{constructor(){this.isInitialized=!1,this.audioContext=new AudioContext,this.masterGain=this.audioContext.createGain(),this.musicGain=this.audioContext.createGain(),this.sfxGain=this.audioContext.createGain(),this.settings=new s,this.tracks=new Map,this.eventBus=a.l.getInstance(),this.previousVolumes={master:this.settings.getVolume("master"),music:this.settings.getVolume("music"),sfx:this.settings.getVolume("sfx")},this.settings.setMuted(!0)}static getInstance(){return o.instance||(o.instance=new o),o.instance}async initialize(){if(!this.isInitialized)try{this.masterGain.connect(this.audioContext.destination),this.musicGain.connect(this.masterGain),this.sfxGain.connect(this.masterGain),this.applySettings(),this.isInitialized=!0}catch(e){throw console.error("Failed to initialize audio system:",e),e}}async loadTrack(e,t,i){try{if(this.tracks.has(e))return console.warn(`Audio track ${e} already loaded, skipping`),{success:!0};const s=await fetch(t);if(!s.ok)throw new Error(`Failed to fetch audio: ${s.status} ${s.statusText}`);const a=await s.arrayBuffer(),o=await this.audioContext.decodeAudioData(a),r="music"===i?this.musicGain:this.sfxGain,c=new n(this.audioContext,o,i,r);return this.tracks.set(e,c),"music"!==i||this.settings.isMuted()||(await this.ensureAudioContextRunning(),c.play({loop:!0,volume:this.settings.getVolume("music")})),{success:!0}}catch(t){const i=t instanceof Error?t.message:"Unknown error";return console.error(`Failed to load audio track ${e}:`,t),{success:!1,error:i}}}async play(e,t={}){const i=this.tracks.get(e);if(i){await this.ensureAudioContextRunning();const e=i.getType(),s=t.volume??this.settings.getVolume(e);i.play({...t,volume:s})}else console.warn(`Audio track '${e}' not found`)}stop(e){const t=this.tracks.get(e);t&&t.stop()}setVolume(e,t){this.settings.setVolume(e,t),this.settings.isMuted()||(this.applySettings(),this.tracks.forEach((i=>{i.getType()===e&&i.setVolume(t)})))}getVolume(e){return this.settings.getVolume(e)}mute(){this.settings.isMuted()||(this.previousVolumes={master:this.settings.getVolume("master"),music:this.settings.getVolume("music"),sfx:this.settings.getVolume("sfx")},this.settings.setMuted(!0),this.applySettings(),this.tracks.forEach((e=>{"music"===e.getType()&&e.stop()})),this.eventBus.emit("audioStateChanged",{muted:!0}))}unmute(){this.settings.isMuted()&&(this.settings.setMuted(!1),this.applySettings(),this.tracks.forEach((e=>{if("music"===e.getType()){const t=this.settings.getVolume("music");e.play({loop:!0,volume:t})}})),"suspended"===this.audioContext.state&&this.audioContext.resume(),this.eventBus.emit("audioStateChanged",{muted:!1}))}isMuted(){return this.settings.isMuted()}getPreviousVolume(e){return this.previousVolumes[e]}applySettings(){const e=this.settings.isMuted()?0:this.settings.getVolume("master"),t=this.settings.getVolume("music"),i=this.settings.getVolume("sfx");this.masterGain.gain.value=e,this.musicGain.gain.value=t,this.sfxGain.gain.value=i,this.tracks.forEach((e=>{const s="music"===e.getType()?t:i;e.setVolume(s)})),this.settings.isMuted()||"suspended"!==this.audioContext.state||this.audioContext.resume()}getSettings(){return this.settings}async suspendAudio(){"running"===this.audioContext.state&&await this.audioContext.suspend()}async resumeAudio(){"suspended"===this.audioContext.state&&await this.audioContext.resume()}async ensureAudioContextRunning(){if("suspended"===this.audioContext.state)try{await this.audioContext.resume()}catch(e){console.warn("Failed to resume audio context:",e)}}dispose(){this.tracks.forEach((e=>{e.stop(),e.dispose()})),this.tracks.clear(),"closed"!==this.audioContext.state&&(this.masterGain.disconnect(),this.musicGain.disconnect(),this.sfxGain.disconnect(),this.audioContext.close()),this.isInitialized=!1}}},199:(e,t,i)=>{i.d(t,{K:()=>s});class s{constructor(e){this.tileSize=e,this.tileWidth=2*e,this.tileHeight=e}tileToScreen(e,t){return{x:(e-t)*this.tileWidth/2,y:(e+t)*this.tileHeight/2}}screenToTile(e,t){return{x:(e/(this.tileWidth/2)+t/(this.tileHeight/2))/2,y:(t/(this.tileHeight/2)-e/(this.tileWidth/2))/2}}getTileSize(){return this.tileSize}getTileWidth(){return this.tileWidth}getTileHeight(){return this.tileHeight}getTileBounds(e,t){const i=this.tileToScreen(e,t);return{x:i.x-this.tileWidth/2,y:i.y-this.tileHeight/2,width:this.tileWidth,height:this.tileHeight}}getTileCenter(e,t){const i=this.tileToScreen(e,t);return{x:i.x,y:i.y}}getTileFromPoint(e){return this.screenToTile(e.x,e.y)}getTileFromScreenPoint(e){return this.screenToTile(e.x,e.y)}getScreenPointFromTile(e){return this.tileToScreen(e.x,e.y)}}},361:(e,t,i)=>{i.d(t,{w:()=>a});var s=i(480),n=i(159);class a{constructor(){this.eventBus=s.l.getInstance(),this.audioSystem=n.g.getInstance(),this.isDebugMode=!1}static getInstance(){return a.instance||(a.instance=new a),a.instance}setGameReference(e){this.game=e}async executeActions(e,t){if(e&&0!==e.length){this.debugLog(`Executing ${e.length} actions${t?` for element ${t}`:""}`);for(const t of e)try{await this.executeAction(t)}catch(e){if(console.error(`Script execution error for action ${t.action}:`,e),this.isDebugMode){const i=e instanceof Error?e.message:String(e);this.displayDebugError(`Script Error: ${t.action} failed - ${i}`)}}}}async executeAction(e){switch(this.debugLog(`Executing action: ${e.action}`,e.params),e.action){case"changeState":await this.executeStateChange(e);break;case"transitionScene":await this.executeSceneTransition(e);break;case"panTo":this.executeCameraPan(e);break;case"zoomTo":this.executeCameraZoom(e);break;case"shakeCamera":this.executeCameraShake(e);break;case"playTrack":await this.executePlayTrack(e);break;case"playSFX":await this.executePlaySFX(e);break;case"setVolume":this.executeSetVolume(e);break;case"showDialog":this.executeShowDialog(e);break;case"showOverlay":this.executeShowOverlay(e);break;case"displayMessage":this.executeDisplayMessage(e);break;case"pauseGame":await this.executePauseGame(e);break;case"reloadScene":await this.executeReloadScene(e);break;default:throw new Error(`Unknown action type: ${e.action}`)}}async executeStateChange(e){if(!this.game)throw new Error("Game reference not set");const{state:t}=e.params;this.debugLog(`Changing game state to: ${t}`),await this.game.handleGameStateChange(t),this.eventBus.emit("scriptStateChange",{newState:t})}async executeSceneTransition(e){if(!this.game)throw new Error("Game reference not set");const{target:t,transitionType:i="fade",spawnPoint:s}=e.params;this.debugLog(`Transitioning to scene: ${t}`),await this.game.sceneManager.transitionToScene(t,i,s)}executeCameraPan(e){if(!this.game)throw new Error("Game reference not set");const{x:t,y:i,duration:s=1e3}=e.params;this.debugLog(`Panning camera to: (${t}, ${i})`);const n=this.game.camera.getPosition(),a=t,o=i,r=Date.now(),c=setInterval((()=>{const e=Date.now()-r,t=Math.min(e/s,1),i=1-Math.pow(1-t,3),h=n.x+(a-n.x)*i,l=n.y+(o-n.y)*i;this.game.camera.setPosition({x:h,y:l}),t>=1&&clearInterval(c)}),16)}executeCameraZoom(e){if(!this.game)throw new Error("Game reference not set");const{zoom:t,duration:i=500}=e.params;this.debugLog(`Zooming camera to: ${t}`);const s=this.game.camera.getZoom(),n=t,a=Date.now(),o=setInterval((()=>{const e=Date.now()-a,t=Math.min(e/i,1),r=1-Math.pow(1-t,3),c=s+(n-s)*r;this.game.camera.setZoom(c),t>=1&&clearInterval(o)}),16)}executeCameraShake(e){if(!this.game)throw new Error("Game reference not set");const{intensity:t=10,duration:i=500}=e.params;this.debugLog(`Shaking camera: intensity=${t}, duration=${i}`);const s=this.game.camera.getPosition(),n=i/50;let a=0;const o=setInterval((()=>{if(a++,a>=n)return this.game.camera.setPosition(s),void clearInterval(o);const e=t*(1-a/n),i=(Math.random()-.5)*e,r=(Math.random()-.5)*e;this.game.camera.setPosition({x:s.x+i,y:s.y+r})}),50)}async executePlayTrack(e){const{track:t,loop:i=!1,volume:s=1}=e.params;this.debugLog(`Playing track: ${t}`);try{await this.audioSystem.play(t,{loop:i,volume:s})}catch(e){console.warn(`Failed to play track ${t}:`,e),this.isDebugMode&&this.displayDebugError(`Audio track '${t}' not found - skipping playback`)}}async executePlaySFX(e){const{track:t,volume:i=1}=e.params;this.debugLog(`Playing SFX: ${t}`);try{await this.audioSystem.play(t,{volume:i})}catch(e){console.warn(`Failed to play SFX ${t}:`,e),this.isDebugMode&&this.displayDebugError(`SFX track '${t}' not found - skipping playback`)}}executeSetVolume(e){const{type:t,volume:i}=e.params;this.debugLog(`Setting ${t} volume to: ${i}`),this.audioSystem.setVolume(t,i)}executeShowDialog(e){if(!this.game)throw new Error("Game reference not set");const{text:t,title:i,duration:s}=e.params;this.debugLog(`Showing dialog: ${t.substring(0,50)}...`);const n="script-dialog-"+Date.now(),a={title:i||void 0,autoDismissAfter:s?s/1e3:void 0};this.game.dialogManager.showDialog(n,t,a)}executeShowOverlay(e){if(!this.game)throw new Error("Game reference not set");const{type:t}=e.params;this.debugLog(`Showing overlay: ${t}`),this.eventBus.emit("showOverlay",{type:t})}executeDisplayMessage(e){const{text:t,duration:i=3e3,position:s="center"}=e.params;this.debugLog(`Displaying message: ${t}`),this.eventBus.emit("displayMessage",{text:t,duration:i,position:s})}async executePauseGame(e){if(!this.game)throw new Error("Game reference not set");const{showMenu:t=!0}=e.params||{};this.debugLog(`Pausing game, showMenu: ${t}`),await this.game.handleGameStateChange("PAUSED"),t&&this.eventBus.emit("showOverlay",{type:"menu"})}async executeReloadScene(e){if(!this.game)throw new Error("Game reference not set");this.debugLog("Reloading current scene"),await this.game.sceneManager.reloadCurrentScene()}validateAction(e){return e.action?["changeState","transitionScene","panTo","zoomTo","shakeCamera","playTrack","playSFX","setVolume","showDialog","showOverlay","displayMessage","pauseGame","reloadScene"].includes(e.action)?this.validateActionParams(e):{isValid:!1,error:`Unsupported action type: ${e.action}`}:{isValid:!1,error:"Action type is required"}}validateActionParams(e){const{action:t,params:i}=e;switch(t){case"changeState":if(!i?.state)return{isValid:!1,error:"changeState requires state parameter"};break;case"transitionScene":if(!i?.target)return{isValid:!1,error:"transitionScene requires target parameter"};break;case"panTo":if(void 0===i?.x||void 0===i?.y)return{isValid:!1,error:"panTo requires x and y parameters"};break;case"zoomTo":if(void 0===i?.zoom)return{isValid:!1,error:"zoomTo requires zoom parameter"};break;case"playTrack":case"playSFX":if(!i?.track)return{isValid:!1,error:`${t} requires track parameter`};break;case"setVolume":if(!i?.type||void 0===i?.volume)return{isValid:!1,error:"setVolume requires type and volume parameters"};break;case"showDialog":if(!i?.text)return{isValid:!1,error:"showDialog requires text parameter"};break;case"showOverlay":if(!i?.type)return{isValid:!1,error:"showOverlay requires type parameter"};break;case"displayMessage":if(!i?.text)return{isValid:!1,error:"displayMessage requires text parameter"}}return{isValid:!0}}debugLog(e,t){this.isDebugMode&&console.log(`[ScriptEngine] ${e}`,t||"")}displayDebugError(e){this.isDebugMode&&this.eventBus.emit("displayMessage",{text:e,duration:5e3,position:"top"})}}},480:(e,t,i)=>{i.d(t,{l:()=>s});class s{constructor(){this.listeners=new Map}static getInstance(){return s.instance||(s.instance=new s),s.instance}on(e,t){this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(t)}off(e,t){this.listeners.has(e)&&this.listeners.get(e).delete(t)}emit(e,t){if(this.listeners.has(e))for(const i of this.listeners.get(e))i(t)}clear(){this.listeners.clear()}removeAllListeners(e){this.listeners.delete(e)}getListenerCount(e){return this.listeners.get(e)?.size||0}hasListeners(e){return this.listeners.has(e)&&this.listeners.get(e).size>0}}}},t={};function i(s){var n=t[s];if(void 0!==n)return n.exports;var a=t[s]={exports:{}};return e[s](a,a.exports,i),a.exports}i.d=(e,t)=>{for(var s in t)i.o(t,s)&&!i.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},i.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),i.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var s={};i.d(s,{default:()=>_});class n{constructor(e){this.fallbackImage=null,this.fallbackImagePath="assets/missing.png",this.fallbackImageLoaded=!1,this.fallbackAudio=null,this.fallbackAudioLoaded=!1,this.assets=new Map,this.config=e,this.loadingPromises=[],this.loadFallbackImage(),this.loadFallbackAudio()}async loadFallbackImage(){const e=`${this.config.assetsPath}/${this.fallbackImagePath}`;return new Promise((t=>{const i=new Image;i.onload=()=>{this.fallbackImage=i,this.fallbackImageLoaded=!0,t()},i.onerror=()=>{this.fallbackImage=this.createMagentaCheckerboard(),this.fallbackImageLoaded=!0,t()},i.src=e}))}createMagentaCheckerboard(){const e=document.createElement("canvas");e.width=32,e.height=32;const t=e.getContext("2d");t.fillStyle="#ff00ff",t.fillRect(0,0,32,32),t.fillStyle="#000000",t.fillRect(0,0,16,16),t.fillRect(16,16,16,16);const i=new Image;return i.src=e.toDataURL(),i}async loadFallbackAudio(){this.fallbackAudio=this.createSilentAudio(),this.fallbackAudioLoaded=!0}createSilentAudio(){const e=new Audio;return e.src="data:audio/mp3;base64,SUQzBAAAAAABEVRYWFgAAAAtAAADY29tbWVudABCaWdTb3VuZEJhbmsuY29tIC8gTGFTb25vdGhlcXVlLm9yZwBURU5DAAAAHQAAATRCB+ALFE9wKQAAAAAAAAGNgAAGhgAAGjgGz4AAAAAAAGQGQABAAIBAAQBAAIBAAQBAAIBAAQBAAIBAAQBAAIBAAQBAA",e.loop=!1,e.volume=0,e}async loadImage(e){const t=e.startsWith("assets/")?e:`assets/${e}`,i=`${this.config.assetsPath}/${t}`,s=new Promise((t=>{const s=new Image;s.onload=()=>{this.assets.set(e,{type:"image",data:s}),t(s)},s.onerror=()=>{this.fallbackImageLoaded&&this.fallbackImage?(console.warn(`ResourceManager: Failed to load image '${e}', using fallback image.`),this.assets.set(e,{type:"image",data:this.fallbackImage}),t(this.fallbackImage)):this.loadFallbackImage().then((()=>{console.warn(`ResourceManager: Failed to load image '${e}', using fallback image.`),this.assets.set(e,{type:"image",data:this.fallbackImage}),t(this.fallbackImage)}))},s.src=i}));return this.loadingPromises.push(s),s}async loadJSON(e){const t=`${this.config.assetsPath}/${e}`,i=fetch(t).then((t=>{if(!t.ok)throw new Error(`Failed to load JSON: ${e} (${t.status})`);return t.json()})).then((t=>(this.assets.set(e,{type:"json",data:t}),t))).catch((t=>{console.warn(`ResourceManager: Failed to load JSON '${e}':`,t.message);const i={};return this.assets.set(e,{type:"json",data:i}),i}));return this.loadingPromises.push(i),i}async loadAudio(e){const t=e.startsWith("audio/")?e:`audio/music/${e}`,i=`${this.config.assetsPath}/${t}`,s=new Promise((t=>{const s=new Audio;s.oncanplaythrough=()=>{this.assets.set(e,{type:"audio",data:s}),t(s)},s.onerror=()=>{this.fallbackAudioLoaded&&this.fallbackAudio?(console.warn(`ResourceManager: Failed to load audio '${e}', using silent fallback.`),this.assets.set(e,{type:"audio",data:this.fallbackAudio}),t(this.fallbackAudio)):this.loadFallbackAudio().then((()=>{console.warn(`ResourceManager: Failed to load audio '${e}', using silent fallback.`),this.assets.set(e,{type:"audio",data:this.fallbackAudio}),t(this.fallbackAudio)}))},s.src=i}));return this.loadingPromises.push(s),s}async loadSceneConfig(e){const t=`${this.config.assetsPath}/scenes/${e}.json`;return fetch(t).then((t=>{if(!t.ok)throw new Error(`Failed to load scene config: ${e} (${t.status})`);return t.json()})).then((e=>(this.assets.set(t,{type:"json",data:e}),e))).catch((i=>{console.warn(`ResourceManager: Failed to load scene config '${e}':`,i.message);const s={name:e,width:800,height:600,tileSize:32,elements:[]};return this.assets.set(t,{type:"json",data:s}),s}))}getAsset(e){return this.assets.get(e)}getImage(e){const t=this.assets.get(e);return"image"===t?.type?t.data:void 0}getJSON(e){const t=this.assets.get(e);return"json"===t?.type?t.data:void 0}getAudio(e){const t=this.assets.get(e);return"audio"===t?.type?t.data:void 0}getAssetUrl(e){if(e.endsWith(".mp3")||e.endsWith(".wav")||e.endsWith(".ogg")){const t=e.startsWith("audio/")?e:`audio/music/${e}`;return`${this.config.assetsPath}/${t}`}if(e.endsWith(".png")||e.endsWith(".jpg")||e.endsWith(".jpeg")||e.endsWith(".gif")){const t=e.startsWith("assets/")?e:`assets/${e}`;return`${this.config.assetsPath}/${t}`}return`${this.config.assetsPath}/${e}`}async waitForAll(){await Promise.all(this.loadingPromises),this.loadingPromises=[]}clear(){this.assets.clear(),this.loadingPromises=[]}dispose(){for(const[e,t]of this.assets)if("audio"===t.type){const e=t.data;e.pause(),e.src="",e.load()}this.assets.clear(),this.loadingPromises=[],this.fallbackAudio&&(this.fallbackAudio.pause(),this.fallbackAudio.src="",this.fallbackAudio=null),this.fallbackImage=null,this.fallbackImageLoaded=!1,this.fallbackAudioLoaded=!1}}class a{constructor(){this.eventListeners=[],this.keys=new Set,this.mousePosition={x:0,y:0},this.lastMousePosition={x:0,y:0},this.mouseButtons=new Set,this.touchPosition=null,this.isDragging=!1,this.dragStart=null,this.dragEnd=null,this.wheelDelta=0,this.dragDelta={x:0,y:0},this.accumulatedDragDelta={x:0,y:0},this.initializeEventListeners()}initializeEventListeners(){this.addEventListenerWithTracking(window,"keydown",this.handleKeyDown.bind(this)),this.addEventListenerWithTracking(window,"keyup",this.handleKeyUp.bind(this)),this.addEventListenerWithTracking(window,"mousemove",this.handleMouseMove.bind(this)),this.addEventListenerWithTracking(window,"mousedown",this.handleMouseDown.bind(this)),this.addEventListenerWithTracking(window,"mouseup",this.handleMouseUp.bind(this)),this.addEventListenerWithTracking(window,"touchstart",this.handleTouchStart.bind(this)),this.addEventListenerWithTracking(window,"touchmove",this.handleTouchMove.bind(this)),this.addEventListenerWithTracking(window,"touchend",this.handleTouchEnd.bind(this)),this.addEventListenerWithTracking(window,"wheel",this.handleWheel.bind(this))}addEventListenerWithTracking(e,t,i){e.addEventListener(t,i),this.eventListeners.push({element:e,event:t,handler:i})}handleKeyDown(e){this.keys.add(e.key.toLowerCase())}handleKeyUp(e){this.keys.delete(e.key.toLowerCase())}handleMouseMove(e){if(this.lastMousePosition={...this.mousePosition},this.mousePosition={x:e.clientX,y:e.clientY},this.isDragging){const e=this.mousePosition.x-this.lastMousePosition.x,t=this.mousePosition.y-this.lastMousePosition.y;this.dragDelta={x:e,y:t},this.accumulatedDragDelta.x+=e,this.accumulatedDragDelta.y+=t}}handleMouseDown(e){this.mouseButtons.add(e.button),this.isDragging=!0,this.dragStart={x:e.clientX,y:e.clientY},this.lastMousePosition={x:e.clientX,y:e.clientY},this.dragDelta={x:0,y:0},this.accumulatedDragDelta={x:0,y:0}}handleMouseUp(e){this.mouseButtons.delete(e.button),this.isDragging=!1,this.dragEnd={x:e.clientX,y:e.clientY},this.dragDelta={x:0,y:0},this.accumulatedDragDelta={x:0,y:0}}handleTouchStart(e){const t=e.touches[0];this.touchPosition={x:t.clientX,y:t.clientY},this.isDragging=!0,this.dragStart={x:t.clientX,y:t.clientY},this.lastMousePosition={x:t.clientX,y:t.clientY},this.dragDelta={x:0,y:0},this.accumulatedDragDelta={x:0,y:0}}handleTouchMove(e){const t=e.touches[0];if(this.touchPosition={x:t.clientX,y:t.clientY},this.isDragging){const e=this.touchPosition.x-this.lastMousePosition.x,t=this.touchPosition.y-this.lastMousePosition.y;this.dragDelta={x:e,y:t},this.accumulatedDragDelta.x+=e,this.accumulatedDragDelta.y+=t,this.lastMousePosition={...this.touchPosition}}}handleTouchEnd(e){this.touchPosition=null,this.isDragging=!1,this.dragStart&&(this.dragEnd={x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY}),this.dragDelta={x:0,y:0},this.accumulatedDragDelta={x:0,y:0}}handleWheel(e){this.wheelDelta=-.1*Math.sign(e.deltaY)}isKeyDown(e){return this.keys.has(e.toLowerCase())}isMouseButtonPressed(e){return this.mouseButtons.has(e)}getMousePosition(){return{...this.mousePosition}}getTouchPosition(){return this.touchPosition?{...this.touchPosition}:null}getDragState(){return this.isDragging}getDragStart(){return this.dragStart?{...this.dragStart}:null}getDragEnd(){return this.dragEnd?{...this.dragEnd}:null}clearDragState(){this.dragStart=null,this.dragEnd=null}getWheelDelta(){const e=this.wheelDelta;return this.wheelDelta=0,e}getDragDelta(){const e={...this.accumulatedDragDelta};return this.accumulatedDragDelta={x:0,y:0},e}getMovementDirection(){const e={x:0,y:0};if(this.isKeyDown("w")&&(e.y-=1),this.isKeyDown("s")&&(e.y+=1),this.isKeyDown("a")&&(e.x-=1),this.isKeyDown("d")&&(e.x+=1),0!==e.x&&0!==e.y){const t=Math.sqrt(e.x*e.x+e.y*e.y);e.x/=t,e.y/=t}return e}dispose(){for(const{element:e,event:t,handler:i}of this.eventListeners)e.removeEventListener(t,i);this.eventListeners=[],this.keys.clear(),this.mouseButtons.clear(),this.touchPosition=null,this.isDragging=!1,this.dragStart=null,this.dragEnd=null,this.wheelDelta=0,this.dragDelta={x:0,y:0},this.accumulatedDragDelta={x:0,y:0}}}class o{constructor(e){this.position={x:0,y:0},this.zoom=e.defaultZoom||1,this.config=e,this.target=null,this.viewportWidth=e.width,this.viewportHeight=e.height,this.bounds={minX:0,minY:0,maxX:e.width,maxY:e.height,width:e.width,height:e.height}}clampPosition(e){const t=this.viewportWidth/this.zoom,i=this.viewportHeight/this.zoom;return{x:Math.max(this.bounds.minX,Math.min(this.bounds.maxX-t,e.x)),y:Math.max(this.bounds.minY,Math.min(this.bounds.maxY-i,e.y))}}update(e){this.target&&this.moveToTarget(e)}moveToTarget(e){if(!this.target)return;const t=this.target.x-this.position.x,i=this.target.y-this.position.y,s=Math.sqrt(t*t+i*i);if(s<1)return this.position=this.clampPosition({...this.target}),void(this.target=null);const n=this.config.cameraSpeed||1,a=t/s*n*e,o=i/s*n*e;this.position=this.clampPosition({x:this.position.x+a,y:this.position.y+o})}worldToScreen(e){return{x:(e.x-this.position.x)*this.zoom,y:(e.y-this.position.y)*this.zoom}}screenToWorld(e){return{x:e.x/this.zoom+this.position.x,y:e.y/this.zoom+this.position.y}}setZoom(e){const t=this.zoom;this.zoom=Math.max(this.config.minZoom||.5,Math.min(this.config.maxZoom||2,e)),t!==this.zoom&&(this.position=this.clampPosition(this.position))}getZoom(){return this.zoom}getPosition(){return{...this.position}}moveTo(e){this.target=this.clampPosition(e)}moveBy(e){this.position=this.clampPosition({x:this.position.x+e.x,y:this.position.y+e.y})}setBounds(e){this.bounds=e,this.position=this.clampPosition(this.position)}setPosition(e){this.position=this.clampPosition(e),this.target=null}setViewportSize(e,t){this.viewportWidth=e,this.viewportHeight=t,this.position=this.clampPosition(this.position)}centerOn(e,t,i=!1){const s={x:e.x-t.width/2/this.zoom,y:e.y-t.height/2/this.zoom};i?this.moveTo(s):this.setPosition(s)}jumpTo(e){this.setPosition(e)}}var r,c=i(199),h=i(480);class l{constructor(e,t,i={}){this.lastClickTime=0,this.clickDebounceMs=100,this.cachedPosition=null,this.lastCameraState=null,this.id=e,this.text=t,this.options={width:i.width||400,height:i.height||200,padding:i.padding||20,backgroundColor:i.backgroundColor||"rgba(0, 0, 0, 0.8)",textColor:i.textColor||"#ffffff",fontSize:i.fontSize||16,fontFamily:i.fontFamily||"Arial",borderColor:i.borderColor||"#ffffff",borderWidth:i.borderWidth||2,borderRadius:i.borderRadius||10,animationSpeed:i.animationSpeed||2,progressBarColor:i.progressBarColor||i.borderColor||"#ffffff",progressBarBgColor:i.progressBarBgColor||"#ffffff",progressBarHeight:i.progressBarHeight||3,progressBarMargin:i.progressBarMargin||10,progressBarAlpha:i.progressBarAlpha??.1,progressBarBgAlpha:i.progressBarBgAlpha??.01,targetPosition:i.targetPosition,offsetY:i.offsetY||-10,maxWidth:i.maxWidth||500,maxHeight:i.maxHeight||300,positioningMode:i.positioningMode||"world"},this.visible=!1,this.currentText="",this.animationTimer=0,this.eventBus=h.l.getInstance(),this.state="dismissed",this.completeTimer=0,this.completeDuration=10,this.position={x:0,y:0},this.dimensions={width:0,height:0}}show(){this.visible=!0,this.currentText="",this.animationTimer=0,this.state="typing",this.completeTimer=0,this.eventBus.emit("dialog",{type:"dialog",dialogId:this.id,action:"start",text:this.text,data:{text:this.text}})}hide(){this.visible=!1,this.state="dismissed",this.completeTimer=0,this.eventBus.emit("dialog",{type:"dialog",dialogId:this.id,action:"end",data:{text:this.text}})}update(e){if(this.visible)if("typing"===this.state){this.animationTimer+=e*this.options.animationSpeed;const t=Math.floor(this.animationTimer*this.text.length);this.currentText=this.text.substring(0,t),this.currentText.length===this.text.length&&(this.state="complete",this.completeTimer=0,this.eventBus.emit("dialog",{type:"dialog",dialogId:this.id,action:"next",data:{text:this.text}}))}else"complete"===this.state&&(this.completeTimer+=e,this.completeTimer>=this.completeDuration&&this.hide())}handleClick(){if(!this.visible)return;const e=Date.now();e-this.lastClickTime<this.clickDebounceMs||(this.lastClickTime=e,"typing"===this.state?(this.currentText=this.text,this.state="complete",this.completeTimer=0):"complete"===this.state&&this.hide())}render(e){if(!this.visible)return;const{padding:t,backgroundColor:i,textColor:s,fontSize:n,fontFamily:a,borderColor:o,borderWidth:r,borderRadius:c}=this.options;e.font=`${n}px ${a}`;const h=this.wrapText(this.currentText,this.options.maxWidth-2*t,e);let l=200;h.forEach((i=>{const s=e.measureText(i).width+2*t;s>l&&(l=s)})),l=Math.max(200,Math.min(l,this.options.maxWidth));const d=1.2*n;let u=h.length*d+2*t;u=Math.max(60,Math.min(u,this.options.maxHeight)),this.dimensions={width:l,height:u},this.options.targetPosition?(this.options.positioningMode,this.position={x:this.options.targetPosition.x-l/2,y:this.options.targetPosition.y+this.options.offsetY-u}):this.position={x:(e.canvas.width-l)/2,y:(e.canvas.height-u)/2},this.position=this.clampToViewport(this.position,l,u,e.canvas.width,e.canvas.height),e.fillStyle=i,e.strokeStyle=o,e.lineWidth=r,e.beginPath(),e.roundRect(this.position.x,this.position.y,l,u,c),e.fill(),e.stroke(),e.fillStyle=s,e.font=`${n}px ${a}`,e.textBaseline="top";const g=this.position.y+t;if(h.forEach(((i,s)=>{e.fillText(i,this.position.x+t,g+s*d)})),"complete"===this.state){const t=.8*l,i=this.options.progressBarHeight,s=this.position.x+.1*l,n=this.position.y+u-i-this.options.progressBarMargin,a=Math.min(1,this.completeTimer/this.completeDuration);e.save(),e.globalAlpha=this.options.progressBarBgAlpha,e.fillStyle=this.options.progressBarBgColor,e.fillRect(s,n,t,i),e.globalAlpha=this.options.progressBarAlpha,e.fillStyle=this.options.progressBarColor,e.fillRect(s,n,t*a,i),e.restore()}}wrapText(e,t,i){const s=e.split(" "),n=[];let a="";return s.forEach((e=>{i.measureText(a+" "+e).width<t?a+=(a?" ":"")+e:(n.push(a),a=e)})),a&&n.push(a),n}isVisible(){return this.visible}getText(){return this.text}setText(e){this.text=e,this.currentText="",this.animationTimer=0}getOptions(){return{...this.options}}setOptions(e){this.options={...this.options,...e}}updateCameraState(e,t){this.lastCameraState={position:{...e},zoom:t},this.cachedPosition=null}clampToViewport(e,t,i,s,n){return{x:Math.max(10,Math.min(s-t-10,e.x)),y:Math.max(10,Math.min(n-i-10,e.y))}}getDimensions(){return{...this.dimensions}}}class d{constructor(){this.currentDialog=null,this.camera=null,this.isometricConverter=null,this.lastCameraPosition=null,this.lastCameraZoom=null,this.eventBus=h.l.getInstance(),this.mouseHandler=()=>{this.currentDialog&&this.currentDialog.isVisible()&&this.currentDialog.handleClick()},window.addEventListener("mousedown",this.mouseHandler),this.eventBus.on("sceneTransition",(e=>{"changeScene"===e.action&&this.hideDialog()})),this.eventBus.on("gameState",(e=>{"TRANSITIONING"===e.state&&this.hideDialog()}))}static getInstance(){return d.instance||(d.instance=new d),d.instance}setCamera(e){this.camera=e}setIsometricConverter(e){this.isometricConverter=e}showDialog(e,t,i={},s){let n;if(this.currentDialog&&this.currentDialog.hide(),s&&this.camera&&this.isometricConverter){if(isNaN(s.x)||isNaN(s.y))return void console.warn("DialogManager: Invalid element position coordinates",s);try{const e=this.isometricConverter.tileToScreen(s.x,s.y);if(isNaN(e.x)||isNaN(e.y))return void console.warn("DialogManager: Isometric conversion produced invalid coordinates",{elementPosition:s,isoPos:e});if("screen"===i.positioningMode){if(n=this.camera.worldToScreen(e),isNaN(n.x)||isNaN(n.y))return void console.warn("DialogManager: Screen conversion produced invalid coordinates",{isoPos:e,targetPosition:n});n.y-=s.spriteHeight}else n=e,n.y-=s.spriteHeight}catch(e){return void console.error("DialogManager: Error in coordinate conversion",e)}}this.currentDialog=new l(e,t,{...i,targetPosition:n}),this.currentDialog.show(),this.camera&&(this.lastCameraPosition=this.camera.getPosition(),this.lastCameraZoom=this.camera.getZoom())}hideDialog(){this.currentDialog&&(this.currentDialog.hide(),this.currentDialog=null)}update(e){if(this.currentDialog&&(this.currentDialog.update(e),this.camera)){const e=this.camera.getPosition(),t=this.camera.getZoom(),i=!this.lastCameraPosition||this.lastCameraPosition.x!==e.x||this.lastCameraPosition.y!==e.y,s=this.lastCameraZoom!==t;(i||s)&&(this.currentDialog.updateCameraState(e,t),this.lastCameraPosition={...e},this.lastCameraZoom=t)}}render(e){if(this.currentDialog)if("world"===this.currentDialog.getOptions().positioningMode&&this.camera){e.save();try{const t=this.camera.getPosition();if(!t||isNaN(t.x)||isNaN(t.y))return void console.warn("DialogManager: Invalid camera position, skipping world-positioned dialog render",t);const i=this.camera.getZoom();if(isNaN(i)||i<=0)return void console.warn("DialogManager: Invalid camera zoom, skipping world-positioned dialog render",i);e.translate(-t.x*i,-t.y*i),e.scale(i,i),this.currentDialog.render(e)}catch(e){console.error("DialogManager: Error rendering world-positioned dialog",e)}finally{e.restore()}}else try{this.currentDialog.render(e)}catch(e){console.error("DialogManager: Error rendering screen-positioned dialog",e)}}isDialogVisible(){return this.currentDialog?.isVisible()||!1}dispose(){this.hideDialog(),window.removeEventListener("mousedown",this.mouseHandler),this.camera=null,this.isometricConverter=null,this.lastCameraPosition=null,this.lastCameraZoom=null}getCameraState(){return{position:this.lastCameraPosition,zoom:this.lastCameraZoom}}}!function(e){e.START_SCREEN="START_SCREEN",e.LOADING="LOADING",e.PLAYING="PLAYING",e.PAUSED="PAUSED",e.DIALOG="DIALOG",e.MENU="MENU",e.TRANSITIONING="TRANSITIONING"}(r||(r={}));class u{constructor(e,t){this.activeLayer=null,this.config=e,this.parentContainer=t,this.eventBus=h.l.getInstance(),this.uiLayers=new Map,this.container=document.createElement("div"),this.container.id="game-ui-container",this.container.className="game-ui-container",this.parentContainer.appendChild(this.container),this.eventBus.on("gameState",(e=>{this.handleGameStateChange(e.state,e.data)}))}static getInstance(e,t){return!u.instance&&e&&t&&(u.instance=new u(e,t)),u.instance}registerUILayer(e,t){this.uiLayers.set(e,t),t.classList.add("game-ui-layer"),t.style.display="none",this.container.appendChild(t)}showLayer(e){this.activeLayer&&this.uiLayers.has(this.activeLayer)&&(this.uiLayers.get(this.activeLayer).style.display="none"),this.uiLayers.has(e)&&(this.uiLayers.get(e).style.display="flex",this.activeLayer=e)}hideAllLayers(){this.uiLayers.forEach((e=>{e.style.display="none"})),this.activeLayer=null}getContainer(){return this.container}handleGameStateChange(e,t){switch(e){case r.START_SCREEN:this.showLayer("start-screen");break;case r.LOADING:this.hideAllLayers(),this.showLayer("loading-screen");break;case r.PLAYING:this.hideAllLayers();break;case r.PAUSED:this.showLayer("pause-menu");break;case r.MENU:"settings"===t?.menu?this.showLayer("settings-overlay"):"credits"===t?.menu&&this.showLayer("credits-overlay")}}}class g{constructor(e){this.options=e,this.eventBus=h.l.getInstance(),this.createStartScreen(),this.setupEventListeners();const t=window.game;t&&"function"==typeof t.isGameInProgress&&this.setContinueButtonVisible(t.isGameInProgress())}createStartScreen(){this.element=document.createElement("div"),this.element.className="game-start-screen";const e=document.createElement("div");e.className="game-start-content";const t=document.createElement("h1");t.className="game-start-title",t.textContent=this.options.title,this.continueButton=document.createElement("button"),this.continueButton.className="game-continue-button",this.continueButton.textContent="Continue",this.continueButton.style.display="none",this.startButton=document.createElement("button"),this.startButton.className="game-start-button",this.startButton.textContent="New Game";const i=document.createElement("button");i.className="game-settings-button",i.textContent="Settings";const s=document.createElement("button");s.className="game-credits-button",s.textContent="Credits",e.appendChild(t),e.appendChild(this.continueButton),e.appendChild(this.startButton),this.options.showSettings&&e.appendChild(i),this.options.showCredits&&e.appendChild(s),this.element.appendChild(e),u.getInstance().registerUILayer("start-screen",this.element)}setupEventListeners(){this.continueButton&&this.continueButton.addEventListener("click",(()=>{this.eventBus.emit("gameState",{type:"gameState",state:r.PLAYING})})),this.startButton&&this.startButton.addEventListener("click",(()=>{this.eventBus.emit("gameState",{type:"gameState",state:r.LOADING})}));const e=this.element.querySelector(".game-settings-button");e&&e.addEventListener("click",(()=>{this.eventBus.emit("gameState",{type:"gameState",state:r.MENU,data:{menu:"settings"}})}));const t=this.element.querySelector(".game-credits-button");t&&t.addEventListener("click",(()=>{this.eventBus.emit("gameState",{type:"gameState",state:r.MENU,data:{menu:"credits"}})})),this.eventBus.on("gameActiveState",(e=>{this.setContinueButtonVisible(e.active)}))}setContinueButtonVisible(e){this.continueButton.style.display=e?"block":"none"}show(){this.element.style.display="flex",this.playBackgroundMusic()}hide(){this.element.style.display="none",this.stopBackgroundMusic()}playBackgroundMusic(){this.options.music&&!this.backgroundMusic&&(this.backgroundMusic=new Audio(this.options.music),this.backgroundMusic.loop=!0,this.backgroundMusic.volume=.5,this.backgroundMusic.play().catch((e=>{console.warn("Failed to play background music:",e)})))}stopBackgroundMusic(){this.backgroundMusic&&(this.backgroundMusic.pause(),this.backgroundMusic.currentTime=0)}static addStyles(){const e=document.createElement("style");e.textContent="\n      .game-start-screen {\n        position: absolute;\n        top: 0;\n        left: 0;\n        width: 100%;\n        height: 100%;\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), var(--game-background, #000);\n        z-index: 10;\n      }\n      \n      .game-start-content {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        gap: 2rem;\n        padding: 2rem;\n        background: rgba(0, 0, 0, 0.8);\n        border-radius: 1rem;\n        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);\n    }\n      \n      .game-start-title {\n        color: var(--game-text, #fff);\n        font-size: 3rem;\n        margin: 0;\n        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);\n      }\n      \n      .game-start-button,\n      .game-settings-button,\n      .game-credits-button {\n        padding: 1rem 2rem;\n        font-size: 1.2rem;\n        color: var(--game-text, #fff);\n        background: var(--game-accent, #4fc3f7);\n        border: none;\n        border-radius: 0.5rem;\n        cursor: pointer;\n        transition: all 0.2s ease;\n        min-width: 200px;\n      }\n      \n      .game-start-button:hover,\n      .game-settings-button:hover,\n      .game-credits-button:hover {\n        background: var(--game-accent-hover, #0288d1);\n        transform: translateY(-2px);\n        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);\n  }\n\n      .game-start-button:active,\n      .game-settings-button:active,\n      .game-credits-button:active {\n        transform: translateY(0);\n        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);\n      }\n    ",document.head.appendChild(e)}}class m{constructor(e){this.element=document.createElement("div"),this.element.className="game-credits-overlay",this.onClose=e;const t=document.createElement("div");t.className="game-credits-modal",this.closeButton=document.createElement("button"),this.closeButton.className="game-credits-close",this.closeButton.innerHTML="&times;",this.closeButton.title="Close",this.closeButton.onclick=()=>this.handleClose();const i=document.createElement("h2");i.className="game-credits-title",i.textContent="Credits";const s=document.createElement("div");s.className="game-credits-content",s.innerHTML="\n      <p><strong>Isometric Game Engine</strong></p>\n      <p>Created by Your Name</p>\n      <p>&copy; 2024</p>\n      <p>Special thanks to all contributors!</p>\n    ",t.appendChild(this.closeButton),t.appendChild(i),t.appendChild(s),this.element.appendChild(t),u.getInstance().registerUILayer("credits-overlay",this.element),this.element.addEventListener("mousedown",(e=>{e.target===this.element&&this.handleClose()}))}handleClose(){this.onClose&&this.onClose()}show(){}hide(){}}var p,f=i(159);class y{constructor(e,t,i){this.config=e,this.eventBus=h.l.getInstance(),this.audioSystem=f.g.getInstance(),this.onConfigUpdate=t,this.onClose=i,this.defaultConfig={...e},this.formState={...e},this.element=document.createElement("div"),this.element.className="game-settings-overlay";const s=document.createElement("div");s.className="game-settings-modal",this.closeButton=document.createElement("button"),this.closeButton.className="game-settings-close",this.closeButton.innerHTML="&times;",this.closeButton.title="Close",this.closeButton.onclick=()=>this.hide();const n=document.createElement("h2");n.className="game-settings-title",n.textContent="Settings";const a=document.createElement("form");a.className="game-settings-form",a.onsubmit=e=>{e.preventDefault()},a.appendChild(this.createNumberInput("Canvas Width","width",this.config.width,320,3840)),a.appendChild(this.createNumberInput("Canvas Height","height",this.config.height,240,2160)),a.appendChild(this.createNumberInput("Keyboard Speed","keyboardSpeed",this.config.keyboardSpeed??15,1,100)),a.appendChild(this.createNumberInput("Mouse Speed","mouseSpeed",this.config.mouseSpeed??2,.1,100,.1));const o=this.createAudioSettings();a.appendChild(o),this.applyButton=document.createElement("button"),this.applyButton.type="button",this.applyButton.className="game-settings-apply",this.applyButton.textContent="Apply",this.applyButton.onclick=e=>{e.preventDefault(),this.applySettings()},a.appendChild(this.applyButton),this.resetButton=document.createElement("button"),this.resetButton.type="button",this.resetButton.className="game-settings-reset",this.resetButton.textContent="Reset to Defaults",this.resetButton.onclick=e=>{e.preventDefault(),this.resetSettings()},a.appendChild(this.resetButton),s.appendChild(this.closeButton),s.appendChild(n),s.appendChild(a),this.element.appendChild(s),u.getInstance().registerUILayer("settings-overlay",this.element),this.element.addEventListener("mousedown",(e=>{e.target===this.element&&this.hide()}))}createNumberInput(e,t,i,s,n,a=1){const o=document.createElement("div");o.className="game-settings-field";const r=document.createElement("label");r.textContent=e;const c=document.createElement("input");return c.type="number",c.value=String(i),c.min=String(s),c.max=String(n),c.step=String(a),c.oninput=()=>{this.formState[t]=c.valueAsNumber},o.appendChild(r),o.appendChild(c),o}createRangeInput(e,t,i,s,n,a){const o=document.createElement("div");o.className="game-settings-field";const r=document.createElement("label");r.textContent=e;const c=document.createElement("input");c.type="range",c.value=String(i),c.min=String(s),c.max=String(n),c.step=String(a);const h=document.createElement("span");return h.textContent=String(i),c.oninput=()=>{h.textContent=c.value,this.formState[t]=parseFloat(c.value)},o.appendChild(r),o.appendChild(c),o.appendChild(h),o}createCheckbox(e,t,i){const s=document.createElement("div");s.className="game-settings-field";const n=document.createElement("label");n.textContent=e;const a=document.createElement("input");return a.type="checkbox",a.checked=i,a.onchange=()=>{this.formState[t]=a.checked},s.appendChild(n),s.appendChild(a),s}createAudioSettings(){const e=document.createElement("div");e.className="game-settings-section";const t=this.createVolumeControl("Master Volume","masterVolume",this.audioSystem.getVolume("master"),(e=>this.audioSystem.setVolume("master",e))),i=this.createVolumeControl("Music Volume","musicVolume",this.audioSystem.getVolume("music"),(e=>this.audioSystem.setVolume("music",e))),s=this.createVolumeControl("SFX Volume","sfxVolume",this.audioSystem.getVolume("sfx"),(e=>this.audioSystem.setVolume("sfx",e))),n=document.createElement("div");n.className="game-settings-mute-indicator",n.textContent=this.audioSystem.isMuted()?"Audio Muted":"Audio Enabled",e.appendChild(n);const a=()=>{const t=this.audioSystem.isMuted();e.querySelectorAll('input[type="range"], input[type="number"]').forEach((e=>{e.disabled=t,e.parentElement?.classList.toggle("muted",t)})),n.textContent=t?"Audio Muted":"Audio Enabled",n.className="game-settings-mute-indicator "+(t?"muted":"")};return a(),this.eventBus.on("audioStateChanged",(()=>{a()})),e.appendChild(t),e.appendChild(i),e.appendChild(s),e}createVolumeControl(e,t,i,s){const n=document.createElement("div");n.className="game-settings-field";const a=document.createElement("label");a.textContent=e,n.appendChild(a);const o=document.createElement("input");o.type="range",o.id=t,o.min="0",o.max="1",o.step="0.1",o.value=i.toString(),o.disabled=this.audioSystem.isMuted();const r=document.createElement("input");r.type="number",r.min="0",r.max="1",r.step="0.1",r.value=i.toString(),r.disabled=this.audioSystem.isMuted();const c=document.createElement("span");c.textContent=`${Math.round(100*i)}%`;const h=e=>{const t=Math.max(0,Math.min(1,e));o.value=t.toString(),r.value=t.toString(),c.textContent=`${Math.round(100*t)}%`,s(t)};return o.addEventListener("input",(e=>{const t=parseFloat(e.target.value);h(t)})),r.addEventListener("input",(e=>{const t=parseFloat(e.target.value);h(t)})),n.appendChild(o),n.appendChild(r),n.appendChild(c),n}applySettings(){const e=parseFloat(this.element.querySelector("#masterVolume").value),t=parseFloat(this.element.querySelector("#musicVolume").value),i=parseFloat(this.element.querySelector("#sfxVolume").value);this.audioSystem.setVolume("master",e),this.audioSystem.setVolume("music",t),this.audioSystem.setVolume("sfx",i);const s={...this.formState};this.onConfigUpdate(s),this.hide()}resetSettings(){this.audioSystem.setVolume("master",1),this.audioSystem.setVolume("music",.7),this.audioSystem.setVolume("sfx",.8),this.formState={...this.defaultConfig};const e=this.element.querySelector("#masterVolume"),t=this.element.querySelector("#musicVolume"),i=this.element.querySelector("#sfxVolume");e&&(e.value="1"),t&&(t.value="0.7"),i&&(i.value="0.8"),Object.entries(this.defaultConfig).forEach((([e,t])=>{const i=this.element.querySelector(`[name="${e}"]`);i&&(i.value=String(t))}))}show(){this.element.style.display="flex"}hide(){this.element.style.display="none",this.onClose&&this.onClose()}}class S{constructor(){this.progressValue=0,this.element=document.createElement("div"),this.element.className="game-loading-screen";const e=document.createElement("div");e.className="game-loading-content";const t=document.createElement("h2");t.className="game-loading-title",t.textContent="Loading...";const i=document.createElement("div");i.className="game-loading-progress-container",this.progressBar=document.createElement("div"),this.progressBar.className="game-loading-progress-bar",this.progressText=document.createElement("div"),this.progressText.className="game-loading-progress-text",this.progressText.textContent="0%",i.appendChild(this.progressBar),e.appendChild(t),e.appendChild(i),e.appendChild(this.progressText),this.element.appendChild(e),u.getInstance().registerUILayer("loading-screen",this.element)}updateProgress(e){this.progressValue=Math.max(0,Math.min(1,e)),this.progressBar.style.width=100*this.progressValue+"%",this.progressText.textContent=`${Math.round(100*this.progressValue)}%`}static addStyles(){const e=document.createElement("style");e.textContent="\n      .game-loading-content {\n        display: flex;\n        flex-direction: column;\n        align-items: center;\n        justify-content: center;\n        gap: 2rem;\n        z-index: 1;\n      }\n      \n      .game-loading-title {\n        color: var(--game-text);\n        font-size: 2rem;\n        margin: 0;\n        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);\n      }\n      \n      .game-loading-progress-container {\n        width: 80%;\n        max-width: 400px;\n        height: 12px;\n        background: rgba(255, 255, 255, 0.1);\n        border-radius: 6px;\n        overflow: hidden;\n      }\n      \n      .game-loading-progress-bar {\n        height: 100%;\n        width: 0%;\n        background: var(--game-accent);\n        transition: width 0.3s ease;\n      }\n      \n      .game-loading-progress-text {\n        color: var(--game-text);\n        font-size: 1rem;\n        margin-top: 0.5rem;\n      }\n    ",document.head.appendChild(e)}}class v{constructor(e){this.visible=!1,this.eventListeners=[],this.parentContainer=e,this.eventBus=h.l.getInstance(),this.createMenuButton(),this.setupEventListeners()}static getInstance(e){return!v.instance&&e&&(v.instance=new v(e)),v.instance}createMenuButton(){this.menuButton=document.createElement("div"),this.menuButton.className="game-menu-button",this.menuButton.innerHTML='\n      <svg viewBox="0 0 24 24" width="24" height="24">\n        <path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" />\n      </svg>\n    ';const e=document.createElement("span");e.className="game-menu-tooltip",e.textContent="Menu",this.menuButton.appendChild(e),this.parentContainer.appendChild(this.menuButton),this.hide()}setupEventListeners(){const e=e=>{switch(e.state){case r.PLAYING:this.show();break;case r.TRANSITIONING:case r.LOADING:case r.START_SCREEN:case r.PAUSED:case r.DIALOG:case r.MENU:this.hide()}};this.eventBus.on("gameState",e),this.eventListeners.push({event:"gameState",handler:e});const t=e=>{"changeScene"===e.action&&this.hide()};this.eventBus.on("sceneTransition",t),this.eventListeners.push({event:"sceneTransition",handler:t}),this.menuButton.addEventListener("click",(()=>{this.eventBus.emit("gameState",{type:"gameState",state:r.START_SCREEN})}))}show(){this.menuButton.style.display="flex",this.visible=!0}hide(){this.menuButton.style.display="none",this.visible=!1}isVisible(){return this.visible}cleanup(){for(const{event:e,handler:t}of this.eventListeners)this.eventBus.off(e,t);this.eventListeners=[],this.menuButton.remove()}static addStyles(){const e=document.createElement("style");e.textContent="\n      .game-menu-button {\n        position: absolute;\n        top: 20px;\n        left: 20px;\n        width: 40px;\n        height: 40px;\n        border-radius: 50%;\n        background: rgba(0, 0, 0, 0.5);\n        color: var(--game-text, #fff);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        z-index: 15;\n        transition: all 0.2s ease;\n        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);\n      }\n      \n      .game-menu-button:hover {\n        background: var(--game-accent, #4fc3f7);\n        transform: scale(1.1);\n      }\n      \n      .game-menu-tooltip {\n        position: absolute;\n        left: 50px;\n        background: rgba(0, 0, 0, 0.7);\n        color: var(--game-text, #fff);\n        padding: 4px 8px;\n        border-radius: 4px;\n        font-size: 12px;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.2s ease;\n        white-space: nowrap;\n      }\n      \n      .game-menu-button:hover .game-menu-tooltip {\n        opacity: 1;\n      }\n    ",document.head.appendChild(e)}}class b{constructor(e){this.elements=[],this.canvas=e,this.ctx=e.getContext("2d"),this.setupEventListeners()}setupEventListeners(){this.canvas.addEventListener("mousemove",this.handleMouseMove.bind(this)),this.canvas.addEventListener("mousedown",this.handleMouseDown.bind(this)),this.canvas.addEventListener("mouseup",this.handleMouseUp.bind(this))}handleMouseMove(e){const t=this.canvas.getBoundingClientRect(),i={x:e.clientX-t.left,y:e.clientY-t.top};for(const e of this.getSortedElements())e.isVisible()&&e.handleMouseMove(i)}handleMouseDown(e){const t=this.canvas.getBoundingClientRect(),i={x:e.clientX-t.left,y:e.clientY-t.top};for(const e of this.getSortedElements())if(e.isVisible()&&e.handleMouseDown(i))break}handleMouseUp(e){const t=this.canvas.getBoundingClientRect(),i={x:e.clientX-t.left,y:e.clientY-t.top};for(const e of this.getSortedElements())e.isVisible()&&e.handleMouseUp(i)}addElement(e){this.elements.push(e)}removeElement(e){const t=this.elements.indexOf(e);-1!==t&&this.elements.splice(t,1)}update(e){for(const t of this.elements)t.isVisible()&&t.update(e)}render(){for(const e of this.getSortedElements())e.isVisible()&&e.render(this.ctx)}getSortedElements(){return[...this.elements].sort(((e,t)=>e.getZIndex()-t.getZIndex()))}}!function(e){e.FADE="fade",e.SLIDE_LEFT="slide_left",e.SLIDE_RIGHT="slide_right",e.SLIDE_UP="slide_up",e.SLIDE_DOWN="slide_down",e.ZOOM_IN="zoom_in",e.ZOOM_OUT="zoom_out",e.NONE="none"}(p||(p={}));class x{constructor(){this.canvas=null,this.ctx=null,this.isTransitioning=!1,this.startTime=0,this.currentTransition=null,this.sourceScene=null,this.targetScene=null,this.onComplete=null,this.defaultTransition={type:p.FADE,duration:800,easing:"ease-in-out",color:"#000000"},this.sceneChangeTriggered=!1,this.eventBus=h.l.getInstance()}static getInstance(){return x.instance||(x.instance=new x),x.instance}initialize(e){this.canvas=e,this.ctx=e.getContext("2d")}startTransition(e,t,i={},s){!this.isTransitioning&&this.ctx&&this.canvas?(this.isTransitioning=!0,this.sourceScene=e,this.targetScene=t,this.onComplete=s||null,this.startTime=performance.now(),this.currentTransition={...this.defaultTransition,...i},this.eventBus.emit("gameState",{type:"gameState",state:r.TRANSITIONING,data:{fromScene:this.sourceScene,toScene:this.targetScene}}),requestAnimationFrame(this.updateTransition.bind(this))):console.warn("Cannot start transition - already transitioning or canvas not initialized")}cancelTransition(){this.isTransitioning=!1,this.currentTransition=null,this.sourceScene=null,this.targetScene=null,this.onComplete=null}updateTransition(e){if(!(this.isTransitioning&&this.ctx&&this.canvas&&this.currentTransition))return;const t=e-this.startTime,i=Math.min(t/this.currentTransition.duration,1);this.renderTransition(i),i<1?requestAnimationFrame(this.updateTransition.bind(this)):this.completeTransition()}renderTransition(e){if(!this.ctx||!this.canvas||!this.currentTransition)return;const{width:t,height:i}=this.canvas,{type:s,color:n}=this.currentTransition;switch(s){case p.FADE:this.ctx.fillStyle=n||"#000000";const s=e<.5?2*e:1-2*(e-.5);this.ctx.globalAlpha=s,this.ctx.fillRect(0,0,t,i),this.ctx.globalAlpha=1;break;case p.SLIDE_LEFT:this.ctx.fillStyle=n||"#000000",this.ctx.fillRect(t-t*e,0,t,i);break;case p.SLIDE_RIGHT:this.ctx.fillStyle=n||"#000000",this.ctx.fillRect(0,0,t*e,i);break;case p.SLIDE_UP:this.ctx.fillStyle=n||"#000000",this.ctx.fillRect(0,i-i*e,t,i);break;case p.SLIDE_DOWN:this.ctx.fillStyle=n||"#000000",this.ctx.fillRect(0,0,t,i*e);break;case p.ZOOM_IN:this.ctx.fillStyle=n||"#000000";const a=t*(1-e),o=(t-a)/2,r=(i-a*(i/t))/2;this.ctx.fillRect(0,0,t,i),this.ctx.clearRect(o,r,a,a*(i/t));break;case p.ZOOM_OUT:this.ctx.fillStyle=n||"#000000";const c=t*e,h=(t-c)/2,l=(i-c*(i/t))/2;this.ctx.clearRect(0,0,t,i),this.ctx.fillRect(h,l,c,c*(i/t));case p.NONE:}e>=.5&&!this.sceneChangeTriggered&&(this.sceneChangeTriggered=!0,this.eventBus.emit("sceneTransition",{type:"sceneTransition",action:"changeScene",fromScene:this.sourceScene,toScene:this.targetScene}))}completeTransition(){this.isTransitioning=!1,this.sceneChangeTriggered=!1,this.eventBus.emit("sceneTransition",{type:"sceneTransition",action:"complete",fromScene:this.sourceScene,toScene:this.targetScene}),this.eventBus.emit("gameState",{type:"gameState",state:r.PLAYING}),this.onComplete&&this.onComplete(),this.currentTransition=null,this.sourceScene=null,this.targetScene=null,this.onComplete=null}isActive(){return this.isTransitioning}setDefaultTransition(e){this.defaultTransition={...this.defaultTransition,...e}}}class C{constructor(e){this.parentContainer=e,this.audioSystem=f.g.getInstance(),this.eventBus=h.l.getInstance(),this.createMuteButton(),this.addStyles()}static getInstance(e){return!C.instance&&e&&(C.instance=new C(e)),C.instance}createMuteButton(){this.button=document.createElement("div"),this.button.className="game-mute-button",this.updateButtonIcon();const e=document.createElement("span");e.className="game-mute-tooltip",e.textContent=this.audioSystem.isMuted()?"Unmute":"Mute",this.button.appendChild(e),this.button.addEventListener("click",(()=>{this.toggleMute()})),this.parentContainer.appendChild(this.button),this.hide()}updateButtonIcon(){const e=this.audioSystem.isMuted();this.button.innerHTML=e?'\n      <svg viewBox="0 0 24 24" width="24" height="24">\n        <path fill="currentColor" d="M12,4L9.91,6.09L12,8.18V4M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73L4.27,3M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12Z" />\n      </svg>\n    ':'\n      <svg viewBox="0 0 24 24" width="24" height="24">\n        <path fill="currentColor" d="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z" />\n      </svg>\n    ',this.button.classList.add("animate"),setTimeout((()=>this.button.classList.remove("animate")),300)}toggleMute(){this.audioSystem.isMuted()?this.audioSystem.unmute():this.audioSystem.mute(),this.updateButtonIcon();const e=this.button.querySelector(".game-mute-tooltip");e&&(e.textContent=this.audioSystem.isMuted()?"Unmute":"Mute"),this.eventBus.emit("audioStateChanged",{muted:this.audioSystem.isMuted()})}show(){this.button.style.display="flex"}hide(){this.button.style.display="none"}addStyles(){const e=document.createElement("style");e.textContent="\n      .game-mute-button {\n        position: absolute;\n        top: 20px;\n        right: 20px;\n        width: 40px;\n        height: 40px;\n        border-radius: 50%;\n        background: rgba(0, 0, 0, 0.5);\n        color: var(--game-text, #fff);\n        display: flex;\n        align-items: center;\n        justify-content: center;\n        cursor: pointer;\n        z-index: 15;\n        transition: all 0.2s ease;\n        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);\n      }\n      \n      .game-mute-button:hover {\n        background: var(--game-accent, #4fc3f7);\n        transform: scale(1.1);\n      }\n      \n      .game-mute-button.animate {\n        animation: pulse 0.3s ease;\n      }\n      \n      @keyframes pulse {\n        0% { transform: scale(1); }\n        50% { transform: scale(1.2); }\n        100% { transform: scale(1); }\n      }\n      \n      .game-mute-tooltip {\n        position: absolute;\n        right: 50px;\n        background: rgba(0, 0, 0, 0.7);\n        color: var(--game-text, #fff);\n        padding: 4px 8px;\n        border-radius: 4px;\n        font-size: 12px;\n        opacity: 0;\n        pointer-events: none;\n        transition: opacity 0.2s ease;\n        white-space: nowrap;\n      }\n      \n      .game-mute-button:hover .game-mute-tooltip {\n        opacity: 1;\n      }\n    ",document.head.appendChild(e)}}class w{static getEnabledScenes(){return Array.from(this.SCENE_REGISTRY.values()).filter((e=>e.enabled)).map((e=>e.id))}static getAllScenes(){return Array.from(this.SCENE_REGISTRY.keys())}static isSceneEnabled(e){const t=this.SCENE_REGISTRY.get(e);return!!t&&t.enabled}static sceneExists(e){return this.SCENE_REGISTRY.has(e)}static validateSceneId(e){const t=e.trim().toLowerCase();return this.isSceneEnabled(t)?t:null}static getSceneMetadata(e){return this.SCENE_REGISTRY.get(e)}static getSceneName(e){const t=this.SCENE_REGISTRY.get(e);return t?t.name:e}static getSceneDescription(e){const t=this.SCENE_REGISTRY.get(e);return t?.description||`Scene: ${e}`}static getSceneFilename(e){const t=this.SCENE_REGISTRY.get(e);return t?t.filename:e}static getScenesByCategory(e){return Array.from(this.SCENE_REGISTRY.values()).filter((t=>t.enabled&&t.category===e))}static getWorkspaceScenes(){return this.getScenesByCategory("workspace")}static getScenesByTag(e){return Array.from(this.SCENE_REGISTRY.values()).filter((t=>t.enabled&&t.tags?.includes(e)))}static getSceneOptions(){return Array.from(this.SCENE_REGISTRY.values()).filter((e=>e.enabled)).map((e=>({id:e.id,name:e.name,description:e.description||e.name})))}static getScenesForBuild(e){let t=this.getEnabledScenes();return"production"===e&&(t=t.filter((e=>{const t=this.SCENE_REGISTRY.get(e);return!t?.devOnly}))),t}static setSceneEnabled(e,t){const i=this.SCENE_REGISTRY.get(e);if(i){const s={...i,enabled:t};return this.SCENE_REGISTRY.set(e,s),!0}return!1}static registerScene(e){this.SCENE_REGISTRY.set(e.id,e)}static getRegistryStats(){const e=Array.from(this.SCENE_REGISTRY.values()),t=e.filter((e=>e.enabled)),i=e.filter((e=>!e.enabled)),s={};return e.forEach((e=>{e.category&&(s[e.category]=(s[e.category]||0)+1)})),{total:e.length,enabled:t.length,disabled:i.length,byCategory:s}}static getSceneListFormatted(){return`Available scenes: ${Array.from(this.SCENE_REGISTRY.values()).filter((e=>e.enabled)).map((e=>`${e.id} (${e.name})`)).join(", ")}`}static validateRegistry(){const e=[];for(const[t,i]of this.SCENE_REGISTRY)t!==i.id&&e.push(`Scene ID mismatch: map key '${t}' != scene.id '${i.id}'`),i.name&&""!==i.name.trim()||e.push(`Scene '${t}' has empty name`),i.filename&&""!==i.filename.trim()||e.push(`Scene '${t}' has empty filename`);return{valid:0===e.length,errors:e}}}w.SCENE_REGISTRY=new Map([["ben",{id:"ben",name:"Ben's Workspace",description:"Ben's creative workspace with photography equipment and design tools",enabled:!0,category:"workspace",filename:"ben",author:"Ben",tags:["workspace","photography","creative"]}],["joel",{id:"joel",name:"Joel's Workspace",description:"Joel's technical workspace with cameras and vintage equipment",enabled:!0,category:"workspace",filename:"joel",author:"Joel",tags:["workspace","technical","vintage","cameras"]}],["jonas",{id:"jonas",name:"Jonas's Workspace",description:"Jonas's organized workspace with development tools",enabled:!0,category:"workspace",filename:"jonas",author:"Jonas",tags:["workspace","development","organized"]}],["pati",{id:"pati",name:"Pati's Workspace",description:"Pati's artistic workspace with creative materials",enabled:!0,category:"workspace",filename:"pati",author:"Pati",tags:["workspace","artistic","creative"]}],["nathanael",{id:"nathanael",name:"Nathanael's Workspace",description:"Nathanael's workspace - the original default scene",enabled:!0,category:"workspace",filename:"nathanael",author:"Nathanael",tags:["workspace","default","main"]}]]);var E=i(72);class T{constructor(e,t,i,s){this.time=0,this.lastCameraPos={x:0,y:0},this.config=e,this.width=t,this.height=i,this.camera=s,this.patternCanvas=document.createElement("canvas"),this.patternCtx=this.patternCanvas.getContext("2d"),this.generatePattern()}generatePattern(){const e=this.config.cellSize;this.patternCanvas.width=2*e,this.patternCanvas.height=2*e,this.patternCtx.clearRect(0,0,2*e,2*e),this.patternCtx.fillStyle=this.config.color1,this.patternCtx.fillRect(0,0,e,e),this.patternCtx.fillRect(e,e,e,e),this.patternCtx.fillStyle=this.config.color2,this.patternCtx.fillRect(e,0,e,e),this.patternCtx.fillRect(0,e,e,e)}update(e){0===this.config.scrollSpeed.x&&0===this.config.scrollSpeed.y||(this.time+=e)}mod(e,t){return(e%t+t)%t}render(e){if(!this.config.enabled)return;const{cellSize:t,scrollSpeed:i,opacity:s=1,parallaxFactor:n=0}=this.config;if(!this.camera)return void console.warn("CheckerboardBackground: Camera reference is null, skipping render");const a=this.camera.worldToScreen({x:0,y:0}),o=-a.x*n,r=-a.y*n,c=o+this.time*i.x,h=r+this.time*i.y,l=2*t,d=this.mod(c,l),u=this.mod(h,l);e.save(),e.globalAlpha=s;for(let t=-u;t<e.canvas.height;t+=l)for(let i=-d;i<e.canvas.width;i+=l)e.drawImage(this.patternCanvas,i,t);e.restore(),this.lastCameraPos={x:a.x,y:a.y}}resize(e,t){this.width=e,this.height=t,this.generatePattern()}updateConfig(e){this.config={...this.config,...e},this.generatePattern()}isEnabled(){return this.config.enabled}setEnabled(e){this.config.enabled=e}getConfig(){return{...this.config}}}class k{constructor(e,t,i,s){this.lastUpdateTime=0,this.config=e,this.width=t,this.height=i,this.camera=s,this.layers=[],this.initializeLayers()}initializeLayers(){const e=[...this.config.layers].sort(((e,t)=>(e.parallaxFactor||0)-(t.parallaxFactor||0)));this.layers=e.map((e=>new T(e,this.width,this.height,this.camera)))}update(e){if(!this.config.enabled)return;const t=performance.now(),i=this.lastUpdateTime?(t-this.lastUpdateTime)/1e3:e;this.lastUpdateTime=t;for(const e of this.layers)e.update(i)}render(e){if(this.config.enabled)for(const t of this.layers)t.render(e)}resize(e,t){this.width=e,this.height=t;for(const i of this.layers)i.resize(e,t)}updateConfig(e){this.config={...this.config,...e},e.layers&&this.initializeLayers()}isEnabled(){return this.config.enabled}setEnabled(e){this.config.enabled=e}getConfig(){return{...this.config}}}var I=i(361);class M{constructor(e,t,i,s){this.checkerboardBackground=null,this.connections=[],this.config=e,this.elements=new Map,this.resourceManager=t,this.camera=i,this.gameConfig=s,this.background=null,this.music=null,this.audioSystem=f.g.getInstance(),this.scriptEngine=I.w.getInstance(),e.connections&&(this.connections=[...e.connections])}async initialize(){if(this.config.background&&(this.background=await this.resourceManager.loadImage(this.config.background)),this.config.music&&(this.music=await this.resourceManager.loadAudio(this.config.music),this.music&&(this.music.loop=!0)),this.config.cameraBounds){const e=this.calculateCameraBounds(this.config.cameraBounds);this.camera.setBounds(e)}this.config.checkerboardBackground&&(this.checkerboardBackground=new k(this.config.checkerboardBackground,this.gameConfig.width,this.gameConfig.height,this.camera));for(const e of this.config.elements){const t=new E.SceneElement(e,this.resourceManager);if(await t.initialize(),await this.loadElementSfx(e),this.validateElementScripts(e),e.isConnectionTrigger&&e.connectionId){const i=this.getConnectionById(e.connectionId);if(i){const s=t.getProperty("onClick");t.setProperty("onClick",(()=>{s&&"function"==typeof s&&s();try{h.l.getInstance().emit("sceneConnection",{type:"sceneConnection",fromScene:this.config.name,toScene:i.targetScene,elementId:e.id,connectionId:e.connectionId,spawnPoint:i.spawnPoint})}catch(e){console.error("Failed to emit scene connection event:",e)}}))}}this.elements.set(e.id,t)}}update(e){this.checkerboardBackground&&this.checkerboardBackground.update(e);for(const t of this.elements.values())t.update(e)}render(e){Promise.resolve().then(i.bind(i,72)).then((({SceneElement:e})=>e.incrementFrame())),e.clearRect(0,0,this.gameConfig.width,this.gameConfig.height),this.checkerboardBackground&&this.checkerboardBackground.render(e),this.background&&e.drawImage(this.background,0,0,this.gameConfig.width,this.gameConfig.height);const t=Array.from(this.elements.values()).sort(((e,t)=>{const i=e.getZIndex(),s=t.getZIndex();if(i!==s)return i-s;const n=e.getPosition(),a=t.getPosition();return n.y!==a.y?n.y-a.y:n.x-a.x}));for(const i of t)i.render(e,this.camera)}getElement(e){return this.elements.get(e)}addElement(e){this.elements.set(e.getId(),e)}removeElement(e){this.elements.delete(e)}playMusic(){this.music&&this.music.play().catch((e=>{console.error("Failed to play music:",e)}))}stopMusic(){this.music&&(this.music.pause(),this.music.currentTime=0)}getConfig(){return this.config}getElements(){return this.elements}getCheckerboardBackground(){return this.checkerboardBackground}setCheckerboardBackground(e){e?(this.checkerboardBackground=new k(e,this.gameConfig.width,this.gameConfig.height,this.camera),this.config.checkerboardBackground=e):(this.checkerboardBackground=null,this.config.checkerboardBackground=void 0)}updateCheckerboardBackground(e){this.checkerboardBackground&&(this.checkerboardBackground.updateConfig(e),this.config.checkerboardBackground={...this.config.checkerboardBackground,...e})}getConnections(){return this.connections}getConnectionById(e){return this.connections.find((t=>t.elementId===e))}addConnection(e){this.connections.push(e),this.config.connections||(this.config.connections=[]),this.config.connections.push(e)}removeConnection(e){this.connections=this.connections.filter((t=>t.elementId!==e)),this.config.connections&&(this.config.connections=this.config.connections.filter((t=>t.elementId!==e)))}async loadElementSfx(e){if(!e.sfx)return;const t=[];if(e.sfx.click){const i=`${e.id}_click`,s=this.resourceManager.getAssetUrl(e.sfx.click);t.push(this.audioSystem.loadTrack(i,s,"sfx").then((t=>{t.success||console.warn(`Failed to load click SFX for element ${e.id}:`,t.error)})))}if(e.sfx.hover){const i=`${e.id}_hover`,s=this.resourceManager.getAssetUrl(e.sfx.hover);t.push(this.audioSystem.loadTrack(i,s,"sfx").then((t=>{t.success||console.warn(`Failed to load hover SFX for element ${e.id}:`,t.error)})))}await Promise.all(t)}calculateCameraBounds(e){const t=new c.K(this.config.tileSize);let i,s;if(e.centerTile&&e.halfSize)i={x:e.centerTile.x-e.halfSize.x,y:e.centerTile.y-e.halfSize.y},s={x:e.centerTile.x+e.halfSize.x,y:e.centerTile.y+e.halfSize.y};else{if(!e.minTile||!e.maxTile)throw new Error("Invalid camera bounds configuration");i=e.minTile,s=e.maxTile}const n=[{x:i.x,y:i.y},{x:i.x,y:s.y},{x:s.x,y:i.y},{x:s.x,y:s.y}].map((e=>t.tileToScreen(e.x,e.y))),a=n.map((e=>e.x)),o=n.map((e=>e.y)),r=Math.min(...a),h=Math.max(...a),l=Math.min(...o),d=Math.max(...o),u=h-r,g=d-l;return console.log("Camera Bounds Debug (corrected):",{tileBounds:{minTile:i,maxTile:s},worldCorners:n,worldBounds:{minX:r,maxX:h,minY:l,maxY:d},dimensions:{width:u,height:g}}),{minX:r,minY:l,maxX:h,maxY:d,width:u,height:g}}validateElementScripts(e){if(!e.triggers)return;const t=e.id;console.log(`ðŸ” Validating scripts for element: ${t}`);for(const[i,s]of Object.entries(e.triggers))if(Array.isArray(s))for(let e=0;e<s.length;e++){const n=s[e],a=this.scriptEngine.validateAction(n);a.isValid?console.log(`âœ… Script validation passed for element ${t}, trigger ${i}, action ${e}: ${n.action}`):(console.error(`âŒ Script validation failed for element ${t}, trigger ${i}, action ${e}:`,a.error),console.error("   Action:",n))}else console.error(`âŒ Invalid trigger format for element ${t}, trigger ${i}: Expected array of actions`)}}class A{constructor(e,t,i){this.sceneCache=new Map,this.availableScenes=[],this.resourceManager=e,this.config=t,this.camera=i}async initialize(){this.availableScenes=w.getEnabledScenes(),console.log("SceneManager initialized with scenes from registry:",w.getSceneListFormatted());const e=w.validateRegistry();e.valid||console.warn("SceneRegistry validation errors:",e.errors);try{const e=`${this.config.assetsPath}/scenes/index.json`,t=await fetch(e);if(t.ok){const e=(await t.json()).scenes||[],i=this.availableScenes,s=i.filter((t=>!e.includes(t))),n=e.filter((e=>!i.includes(e)));s.length>0&&console.warn("Scenes in registry but not in index.json:",s),n.length>0&&console.warn("Scenes in index.json but not enabled in registry:",n)}}catch(e){console.info("No scene index.json found, using registry only (this is fine)")}}getAvailableScenes(){return w.getEnabledScenes()}getDefaultSceneName(){const e=this.config.defaultScene,t=w.validateSceneId(e||"");if(t)return t;const i=w.getEnabledScenes();if(i.length>0)return console.warn(`Configured scene '${e}' not available, using first enabled scene: ${i[0]}`),i[0];throw new Error("No scenes available to load - check SceneRegistry configuration")}async loadScene(e){if(!w.isSceneEnabled(e)){const t=w.getEnabledScenes();throw new Error(`Scene ${e} not found or disabled. Available scenes: ${t.join(", ")}`)}let t=this.sceneCache.get(e);if(!t){const i=await this.resourceManager.loadSceneConfig(e);t=new M(i,this.resourceManager,this.camera,this.config),await t.initialize(),this.config.cacheScenes&&this.sceneCache.set(e,t)}return t}getCachedScene(e){return this.sceneCache.get(e)||null}clearCache(){this.sceneCache.clear()}}class D{constructor(e){this.lastTime=0,this.alpha=.3,this.pulse=0,this.canvas=e}render(e){const t=performance.now();this.pulse=.1*Math.sin(.003*t)+.3,e.save(),e.globalAlpha=this.pulse,e.fillStyle="#ff6b35",e.strokeStyle="#ffffff",e.lineWidth=2,e.font="bold 16px Arial, sans-serif",e.textAlign="left",e.textBaseline="top";const i="ðŸ› ï¸ DEV MODE";e.strokeText(i,10,10),e.fillText(i,10,10),e.font="12px Arial, sans-serif",e.fillStyle="#ffffff",e.globalAlpha=.8*this.pulse,e.fillText("Ctrl+Shift+S: Scene Switcher",10,35),e.restore()}dispose(){}}class B{constructor(e,t){this.container=null,this.isVisible=!1,this.availableScenes=[],this.currentScene=null,this.sceneManager=e,this.eventBus=t,this.transitionManager=x.getInstance(),this.eventBus.on("sceneTransition",(e=>{"complete"===e.action&&e.toScene&&(this.currentScene=e.toScene,this.updateUI())}))}async initialize(){this.availableScenes=this.sceneManager.getAvailableScenes(),this.createUI()}createUI(){this.container=document.createElement("div"),this.container.id="dev-scene-switcher",this.container.style.cssText="\n      position: fixed;\n      top: 50%;\n      left: 50%;\n      transform: translate(-50%, -50%);\n      background: rgba(0, 0, 0, 0.9);\n      border: 2px solid #ff6b35;\n      border-radius: 10px;\n      padding: 20px;\n      z-index: 10000;\n      font-family: 'Courier New', monospace;\n      color: white;\n      min-width: 300px;\n      display: none;\n      box-shadow: 0 0 20px rgba(255, 107, 53, 0.5);\n    ";const e=document.createElement("h3");e.textContent="ðŸ› ï¸ Scene Switcher",e.style.cssText="\n      margin: 0 0 15px 0;\n      color: #ff6b35;\n      text-align: center;\n      font-size: 18px;\n    ",this.container.appendChild(e);const t=document.createElement("div");t.id="current-scene-indicator",t.style.cssText="\n      margin-bottom: 15px;\n      padding: 8px;\n      background: rgba(255, 107, 53, 0.2);\n      border-radius: 5px;\n      text-align: center;\n      font-weight: bold;\n    ",this.container.appendChild(t);const i=document.createElement("div");i.style.cssText="\n      display: grid;\n      gap: 8px;\n      margin-bottom: 15px;\n    ",this.availableScenes.forEach((e=>{const t=document.createElement("button");t.textContent=e,t.dataset.scene=e,t.style.cssText="\n        background: rgba(255, 255, 255, 0.1);\n        color: white;\n        border: 1px solid rgba(255, 255, 255, 0.3);\n        padding: 10px 15px;\n        border-radius: 5px;\n        cursor: pointer;\n        font-family: inherit;\n        font-size: 14px;\n        transition: all 0.2s ease;\n      ",t.addEventListener("mouseenter",(()=>{t.style.background="rgba(255, 107, 53, 0.3)",t.style.borderColor="#ff6b35"})),t.addEventListener("mouseleave",(()=>{t.dataset.scene!==this.currentScene&&(t.style.background="rgba(255, 255, 255, 0.1)",t.style.borderColor="rgba(255, 255, 255, 0.3)")})),t.addEventListener("click",(()=>{this.switchToScene(e)})),i.appendChild(t)})),this.container.appendChild(i);const s=document.createElement("button");s.textContent="Close (Esc)",s.style.cssText="\n      background: rgba(255, 255, 255, 0.1);\n      color: #ccc;\n      border: 1px solid rgba(255, 255, 255, 0.3);\n      padding: 8px 15px;\n      border-radius: 5px;\n      cursor: pointer;\n      font-family: inherit;\n      width: 100%;\n      font-size: 12px;\n    ",s.addEventListener("click",(()=>{this.hide()})),this.container.appendChild(s),document.body.appendChild(this.container),document.addEventListener("keydown",(e=>{"Escape"===e.key&&this.isVisible&&(e.preventDefault(),this.hide())})),this.updateUI()}updateUI(){if(!this.container)return;const e=this.container.querySelector("#current-scene-indicator");e&&(e.textContent=`Current Scene: ${this.currentScene||"Unknown"}`),this.container.querySelectorAll("button[data-scene]").forEach((e=>{const t=e;t.dataset.scene===this.currentScene?(t.style.background="rgba(255, 107, 53, 0.5)",t.style.borderColor="#ff6b35",t.style.fontWeight="bold"):(t.style.background="rgba(255, 255, 255, 0.1)",t.style.borderColor="rgba(255, 255, 255, 0.3)",t.style.fontWeight="normal")}))}async switchToScene(e){if(e!==this.currentScene){console.log(`ðŸ› ï¸ DevTools: Switching to scene "${e}"`),this.hide();try{console.log(`ðŸ› ï¸ DevTools: Preloading scene "${e}"...`),await this.sceneManager.loadScene(e),console.log("ðŸ› ï¸ DevTools: Scene preloaded, starting transition..."),this.transitionManager.startTransition(this.currentScene||"unknown",e,{type:p.FADE,duration:600})}catch(t){console.error(`ðŸ› ï¸ DevTools: Failed to switch to scene "${e}":`,t)}}}show(){this.container&&(this.container.style.display="block",this.isVisible=!0,this.updateUI())}hide(){this.container&&(this.container.style.display="none",this.isVisible=!1)}toggle(){this.isVisible?this.hide():this.show()}setCurrentScene(e){this.currentScene=e,this.updateUI()}dispose(){this.container&&this.container.parentNode&&this.container.parentNode.removeChild(this.container),this.container=null}}class N{static getStandaloneConfig(e={}){const t=this.CANVAS_DIMENSIONS.standalone;return{width:t.width,height:t.height,...this.CAMERA_DEFAULTS,...this.WORLD_DEFAULTS,assetsPath:"",defaultScene:this.DEFAULT_SCENE,...this.DEV_DEFAULTS,audio:{...this.AUDIO_DEFAULTS},title:"Isometric Game Engine",...e}}static getWordPressConfig(e={}){const t=this.CANVAS_DIMENSIONS.wordpress;return{width:t.width,height:t.height,...this.CAMERA_DEFAULTS,...this.WORLD_DEFAULTS,defaultScene:this.DEFAULT_SCENE,...this.DEV_DEFAULTS,debugSkipMenu:!1,audio:{...this.AUDIO_DEFAULTS},...e}}static getDevelopmentConfig(e={}){const t=this.CANVAS_DIMENSIONS.development;return{width:t.width,height:t.height,...this.CAMERA_DEFAULTS,...this.WORLD_DEFAULTS,assetsPath:"./assets",defaultScene:this.DEFAULT_SCENE,debug:!0,debugSkipMenu:!1,cacheScenes:!0,audio:{masterVolume:.5,musicVolume:.3,sfxVolume:.7},...e}}static isValidScene(e){return this.AVAILABLE_SCENES.includes(e)}static getDefaultScene(e){return e&&this.isValidScene(e)?e:this.DEFAULT_SCENE}static getAllScenes(){return this.AVAILABLE_SCENES}static getSceneDisplayName(e){return{ben:"Ben's Workspace",joel:"Joel's Workspace",jonas:"Jonas's Workspace",pati:"Pati's Workspace",nathanael:"Nathanael's Workspace"}[e]||e}static getConfigSummary(e){return`Game Config: ${e.width}x${e.height}, Scene: ${e.defaultScene}, Debug: ${e.debug}`}}N.AVAILABLE_SCENES=["ben","joel","jonas","pati","nathanael"],N.DEFAULT_SCENE="nathanael",N.CANVAS_DIMENSIONS={standalone:{width:1200,height:1200,description:"Large canvas for desktop standalone version"},wordpress:{width:800,height:600,description:"Smaller canvas for WordPress integration"},development:{width:1200,height:1200,description:"Development testing size"}},N.CAMERA_DEFAULTS={defaultZoom:1.5,minZoom:.5,maxZoom:2,keyboardSpeed:15,mouseSpeed:2},N.AUDIO_DEFAULTS={masterVolume:1,musicVolume:.7,sfxVolume:1,musicPath:"music",sfxPath:"audio"},N.WORLD_DEFAULTS={tileSize:32,assetsPath:"",scenesPath:"scenes"},N.DEV_DEFAULTS={debug:!1,debugSkipMenu:!1,cacheScenes:!0},N.ANIMATION_CONSTANTS={bounce:{duration:.3,startScale:1.2,endScale:1},dialog:{clickDebounce:100,completeDuration:10,animationSpeed:2},transition:{fadeDuration:600,defaultDuration:800}},N.DEV_TOOLS_CONSTANTS={watermark:{opacity:.3,position:{x:10,y:10},color:"#ff6b35"},sceneSwitcher:{shortcut:"Ctrl+Shift+S",zIndex:1e4,borderColor:"#ff6b35"}};class L{constructor(){this.isEnabled=!1,this.canvas=null,this.currentScene=null,this.camera=null,this.inputManager=null,this.isometricConverter=null,this.hoveredElement=null,this.mouseWorldPos={x:0,y:0},this.mouseTilePos={x:0,y:0},this.mouseScreenPos={x:0,y:0},this.colors={interactable:"rgba(0, 255, 0, 0.15)",nonInteractable:"rgba(128, 128, 128, 0.1)",hovered:"rgba(255, 255, 0, 0.3)",border:{interactable:"rgba(0, 255, 0, 0.7)",nonInteractable:"rgba(128, 128, 128, 0.5)",hovered:"rgba(255, 255, 0, 0.9)"}},this.config={borderWidth:1,hoveredBorderWidth:2,fontSize:11,labelPadding:4,coordinatesPanelWidth:250,coordinatesPanelHeight:120}}initialize(e,t,i){this.canvas=e,this.camera=t,this.inputManager=i,this.isometricConverter=new c.K(32)}setCurrentScene(e){this.currentScene=e,this.hoveredElement=null}toggle(){this.isEnabled=!this.isEnabled,console.log("Hit Box Debugger: "+(this.isEnabled?"ON":"OFF"))}enable(){this.isEnabled=!0}disable(){this.isEnabled=!1,this.hoveredElement=null}isActive(){return this.isEnabled}update(){this.isEnabled&&this.currentScene&&this.camera&&this.inputManager&&(this.updateMouseCoordinates(),this.updateHoveredElement())}render(e){if(!this.isEnabled)return;if(e.save(),e.fillStyle="rgba(255, 0, 0, 0.4)",e.fillRect(10,10,160,60),e.fillStyle="white",e.font="12px Arial",e.strokeStyle="black",e.lineWidth=2,e.strokeText("HitBox Debug ON",15,30),e.fillText("HitBox Debug ON",15,30),e.strokeText("Scene: "+(this.currentScene?"YES":"NO"),15,50),e.fillText("Scene: "+(this.currentScene?"YES":"NO"),15,50),e.restore(),!this.currentScene||!this.camera)return;const t=this.getElementsDebugInfo();for(const i of t)this.renderElementHitBox(e,i);for(const i of t)this.renderElementLabel(e,i);if(this.renderCoordinatesPanel(e),this.hoveredElement){const i=t.find((e=>e.element===this.hoveredElement));i&&this.renderElementDetails(e,i)}}getElementsDebugInfo(){if(!this.currentScene||!this.camera||!this.isometricConverter)return[];const e=Array.from(this.currentScene.getElements().values()),t=[];for(const i of e){const e=i.getPosition(),s=this.isometricConverter.tileToScreen(e.x,e.y),n=this.camera.worldToScreen(s),a=i.getSprite();let o={left:n.x,top:n.y,right:n.x,bottom:n.y,width:0,height:0};if(a){const e=this.camera.getZoom(),t=a.width*e,i=a.height*e;o={left:n.x-t/2,top:n.y-i,right:n.x+t/2,bottom:n.y,width:t,height:i}}t.push({element:i,tilePos:e,worldPos:s,screenPos:n,bounds:o,sprite:a,isInteractable:i.isInteractable(),isHovered:i===this.hoveredElement})}return t}updateMouseCoordinates(){if(!(this.inputManager&&this.camera&&this.isometricConverter&&this.canvas))return;const e=this.inputManager.getMousePosition(),t=this.canvas.getBoundingClientRect();this.mouseScreenPos={x:e.x-t.left,y:e.y-t.top},this.mouseWorldPos=this.camera.screenToWorld(this.mouseScreenPos),this.mouseTilePos=this.isometricConverter.screenToTile(this.mouseWorldPos.x,this.mouseWorldPos.y)}updateHoveredElement(){if(!this.currentScene||!this.inputManager)return void(this.hoveredElement=null);const e=Array.from(this.currentScene.getElements().values());e.reverse();for(const t of e)if(this.isMouseOverElement(t))return void(this.hoveredElement=t);this.hoveredElement=null}isMouseOverElement(e){if(!this.camera||!this.isometricConverter)return!1;const t=e.getSprite();if(!t)return!1;const i=e.getPosition(),s=this.isometricConverter.tileToScreen(i.x,i.y),n=this.camera.worldToScreen(s),a=this.camera.getZoom(),o=t.width*a,r=t.height*a,c=n.x-o/2,h=n.y-r,l=n.x+o/2,d=n.y;return this.mouseScreenPos.x>=c&&this.mouseScreenPos.x<=l&&this.mouseScreenPos.y>=h&&this.mouseScreenPos.y<=d}renderElementHitBox(e,t){const{bounds:i,isInteractable:s,isHovered:n}=t;if(0===i.width||0===i.height)return;let a,o,r;e.save(),n?(a=this.colors.hovered,o=this.colors.border.hovered,r=this.config.hoveredBorderWidth):s?(a=this.colors.interactable,o=this.colors.border.interactable,r=this.config.borderWidth):(a=this.colors.nonInteractable,o=this.colors.border.nonInteractable,r=this.config.borderWidth),e.fillStyle=a,e.fillRect(i.left,i.top,i.width,i.height),e.strokeStyle=o,e.lineWidth=r,e.strokeRect(i.left,i.top,i.width,i.height),e.restore()}renderElementLabel(e,t){const{element:i,screenPos:s,isHovered:n}=t;if(!n)return;e.save();const a=`${i.getId()} (${i.getType()})`,o=this.config.fontSize;e.font=`${o}px Arial`,e.textAlign="center",e.textBaseline="bottom";const r=s.x,c=s.y-10;e.strokeStyle="black",e.lineWidth=3,e.strokeText(a,r,c),e.fillStyle="white",e.fillText(a,r,c),e.restore()}renderCoordinatesPanel(e){if(!this.canvas)return;const t=this.config.coordinatesPanelWidth,i=this.config.coordinatesPanelHeight,s=this.canvas.width-t-10;e.save(),e.fillStyle="rgba(0, 0, 0, 0.6)",e.fillRect(s,10,t,i),e.strokeStyle=N.DEV_TOOLS_CONSTANTS.sceneSwitcher.borderColor,e.lineWidth=2,e.strokeRect(s,10,t,i),e.fillStyle="white",e.font="12px Arial",e.textAlign="left",e.textBaseline="top";const n=s+10;let a=20;if(e.fillStyle=N.DEV_TOOLS_CONSTANTS.sceneSwitcher.borderColor,e.fillText("Mouse Coordinates",n,a),a+=21,e.fillStyle="white",e.fillText(`Screen: (${this.mouseScreenPos.x.toFixed(1)}, ${this.mouseScreenPos.y.toFixed(1)})`,n,a),a+=16,e.fillText(`World: (${this.mouseWorldPos.x.toFixed(1)}, ${this.mouseWorldPos.y.toFixed(1)})`,n,a),a+=16,e.fillText(`Tile: (${this.mouseTilePos.x.toFixed(2)}, ${this.mouseTilePos.y.toFixed(2)})`,n,a),a+=16,this.camera){const t=this.camera.getPosition(),i=this.camera.getZoom();e.fillText(`Camera: (${t.x.toFixed(1)}, ${t.y.toFixed(1)}) @ ${i.toFixed(2)}x`,n,a)}e.restore()}renderElementDetails(e,t){if(!this.canvas)return;const{element:i,tilePos:s,worldPos:n,screenPos:a,bounds:o}=t,r=this.canvas.height-160-10;e.save(),e.fillStyle="rgba(0, 0, 0, 0.7)",e.fillRect(10,r,300,160),e.strokeStyle=this.colors.border.hovered,e.lineWidth=2,e.strokeRect(10,r,300,160),e.fillStyle="white",e.font="12px Arial",e.textAlign="left",e.textBaseline="top";const c=20;let h=r+10;const l=14;e.fillStyle=this.colors.border.hovered,e.fillText(`Element: ${i.getId()} (${i.getType()})`,c,h),h+=17,e.fillStyle="white",e.fillText(`Tile: (${s.x}, ${s.y})`,c,h),h+=l,e.fillText(`World: (${n.x.toFixed(1)}, ${n.y.toFixed(1)})`,c,h),h+=l,e.fillText(`Screen: (${a.x.toFixed(1)}, ${a.y.toFixed(1)})`,c,h),h+=l,e.fillText(`Bounds: ${o.width.toFixed(0)}Ã—${o.height.toFixed(0)} at (${o.left.toFixed(0)}, ${o.top.toFixed(0)})`,c,h),h+=l,e.fillText("Interactable: "+(i.isInteractable()?"Yes":"No"),c,h),h+=l,e.fillText(`Z-Index: ${i.getZIndex()}`,c,h),h+=l;const d=i.getSprite();d?e.fillText(`Sprite: ${d.width}Ã—${d.height}px`,c,h):e.fillText("Sprite: None",c,h),e.restore()}handleEscapeKey(){this.isEnabled&&this.disable()}dispose(){this.isEnabled=!1,this.canvas=null,this.currentScene=null,this.camera=null,this.inputManager=null,this.isometricConverter=null,this.hoveredElement=null}}class P{constructor(){this.sceneManager=null,this.camera=null,this.inputManager=null,this.devWatermark=null,this.sceneSwitcher=null,this.hitBoxDebugger=null,this.isDevMode=!1,this.eventBus=h.l.getInstance(),this.config={},this.isDevMode=this.detectDevMode()}static getInstance(){return P.instance||(P.instance=new P),P.instance}detectDevMode(){return"undefined"!=typeof window&&"localhost"===window.location?.hostname}async initialize(e,t,i,s,n){this.sceneManager=t,this.camera=s,this.inputManager=n,this.config=i,this.isDevMode=this.isDevMode||!!i.debug,this.isDevMode&&(console.log("ðŸ› ï¸ DevTools: Initializing development tools"),this.devWatermark=new D(e),this.sceneSwitcher=new B(t,this.eventBus),await this.sceneSwitcher.initialize(),this.hitBoxDebugger=new L,this.hitBoxDebugger.initialize(e,s,n),this.setupKeyboardShortcuts(),console.log("ðŸ› ï¸ DevTools: Development tools ready"),console.log("ðŸ› ï¸ DevTools: Hit Box Debugger - Press Ctrl+Shift+H to toggle"))}setupKeyboardShortcuts(){document.addEventListener("keydown",(e=>{if(this.isDevMode){if((e.ctrlKey||e.metaKey)&&e.shiftKey)switch(e.key.toLowerCase()){case"s":e.preventDefault(),this.toggleSceneSwitcher();break;case"h":e.preventDefault(),this.toggleHitBoxDebugger()}"Escape"===e.key&&this.hitBoxDebugger?.isActive()&&(e.preventDefault(),this.hitBoxDebugger.handleEscapeKey())}}))}toggleSceneSwitcher(){this.sceneSwitcher&&this.sceneSwitcher.toggle()}toggleHitBoxDebugger(){this.hitBoxDebugger&&this.hitBoxDebugger.toggle()}update(){this.isDevMode&&this.hitBoxDebugger&&this.hitBoxDebugger.update()}render(e){this.isDevMode&&(this.devWatermark&&this.devWatermark.render(e),this.hitBoxDebugger&&this.hitBoxDebugger.render(e))}isDevModeActive(){return this.isDevMode}setCurrentScene(e,t=null){this.sceneSwitcher&&this.sceneSwitcher.setCurrentScene(e),this.hitBoxDebugger&&t&&this.hitBoxDebugger.setCurrentScene(t)}dispose(){this.devWatermark&&(this.devWatermark.dispose(),this.devWatermark=null),this.sceneSwitcher&&(this.sceneSwitcher.dispose(),this.sceneSwitcher=null),this.hitBoxDebugger&&(this.hitBoxDebugger.dispose(),this.hitBoxDebugger=null)}}class V{constructor(e){this.contentType=e,this.items=new Map,this.eventBus=h.l.getInstance()}getItem(e){return this.items.get(e)}getAllItems(){return Array.from(this.items.values())}getItemsByStatus(e){return this.getAllItems().filter((t=>t.status===e))}getItemsByCategory(e){return this.getAllItems().filter((t=>t.category===e))}updateItem(e,t){const i=this.items.get(e);i?this.items.set(e,{...i,...t}):console.warn(`ContentManager: Attempted to update non-existent item: ${e}`)}addItem(e){this.items.set(e.id,e)}hasNewContent(){return this.getItemsByStatus("new").length>0}}class ${constructor(){this.contentTypes=new Map,this.isUIVisible=!1,this.activeTab=null,this.eventBus=h.l.getInstance(),this.setupEventListeners()}static getInstance(){return $.instance||($.instance=new $),$.instance}setupEventListeners(){this.eventBus.on("content",this.handleContentEvent.bind(this))}registerContentType(e){this.contentTypes.set(e.contentType,e)}handleContentEvent(e){const t=this.contentTypes.get(e.type);t?(t.handleContentEvent(e),"open"===e.action||e.autoOpen&&this.shouldAutoOpen(e)?this.openUI(e.type):"update"!==e.action&&"complete"!==e.action||this.showContentIndicator(e.type)):console.warn(`ContentManager: No handler registered for content type: ${e.type}`)}shouldAutoOpen(e){return!1!==e.autoOpen&&(!0===e.autoOpen||"complete"===e.action)}openUI(e){this.isUIVisible=!0,this.activeTab=e||this.getDefaultTab(),this.eventBus.emit("content-ui-open",{tab:this.activeTab})}closeUI(){this.isUIVisible=!1,this.activeTab=null,this.eventBus.emit("content-ui-close",{})}toggleUI(){this.isUIVisible?this.closeUI():this.openUI()}showContentIndicator(e){this.eventBus.emit("content-indicator",{contentType:e,hasNew:this.hasNewContent(e)})}hasNewContent(e){const t=this.contentTypes.get(e);return t?.hasNewContent()||!1}getDefaultTab(){return Array.from(this.contentTypes.keys())[0]||"quest"}getRegisteredContentTypes(){return Array.from(this.contentTypes.keys())}getContentHandler(e){return this.contentTypes.get(e)}isVisible(){return this.isUIVisible}getActiveTab(){return this.activeTab}setActiveTab(e){this.contentTypes.has(e)&&(this.activeTab=e,this.eventBus.emit("content-tab-change",{tab:e}))}}class R extends V{constructor(){super("quest")}handleContentEvent(e){switch(e.action){case"update":this.handleQuestUpdate(e);break;case"complete":this.handleQuestComplete(e);break;case"open":break;default:console.warn(`QuestTracker: Unknown action: ${e.action}`)}}handleQuestUpdate(e){const t=this.getItem(e.id);t?this.updateExistingQuest(t,e):this.createNewQuest(e)}handleQuestComplete(e){const t=this.getItem(e.id);t?(t.data.objectives&&t.data.objectives.forEach((e=>e.completed=!0)),this.updateItem(e.id,{status:"completed",data:{...t.data,progress:100,...e.data}})):console.warn(`QuestTracker: Attempted to complete non-existent quest: ${e.id}`)}updateExistingQuest(e,t){const i={timestamp:Date.now()};if(t.data?.objectiveId){const s=e.data.objectives.map((e=>e.id===t.data.objectiveId?{...e,completed:t.data.completed??!0,description:t.data.objectiveDescription??e.description}:e));i.data={...e.data,objectives:s,...t.data};const n=s.filter((e=>e.completed&&!e.optional)),a=s.filter((e=>!e.optional)),o=a.length>0?n.length/a.length*100:0;i.data&&(i.data.progress=o),100===o?i.status="completed":o>0&&(i.status="in-progress")}else i.data={...e.data,...t.data},t.data?.status&&(i.status=t.data.status);this.updateItem(t.id,i)}createNewQuest(e){const t={id:e.id,type:"quest",status:"new",title:e.data?.title||`Quest: ${e.id}`,description:e.data?.description,category:e.data?.category||"main",tags:e.data?.tags||[],timestamp:Date.now(),data:{objectives:e.data?.objectives||[],progress:0,location:e.data?.location,npc:e.data?.npc,reward:e.data?.reward},connections:e.data?.connections||[]};t.data.objectives.length>0&&(t.status="in-progress"),this.addItem(t)}startQuest(e,t){const i=t.objectives.map((e=>({...e,completed:!1})));this.eventBus.emit("content",{action:"update",type:"quest",id:e,data:{...t,objectives:i}})}completeObjective(e,t){this.eventBus.emit("content",{action:"update",type:"quest",id:e,data:{objectiveId:t,completed:!0}})}completeQuest(e,t){this.eventBus.emit("content",{action:"complete",type:"quest",id:e,data:t?{reward:t}:void 0,autoOpen:!0})}getQuestProgress(e){const t=this.getItem(e);return t?.data?.progress||0}getActiveQuests(){return this.getItemsByStatus("in-progress")}getCompletedQuests(){return this.getItemsByStatus("completed")}getNewQuests(){return this.getItemsByStatus("new")}}class G{constructor(e){this.hasNewContent=!1,this.parentContainer=e,this.contentManager=$.getInstance(),this.eventBus=h.l.getInstance(),this.createElement(),this.setupEventListeners()}createElement(){this.element=document.createElement("div"),this.element.className="content-fab",this.button=document.createElement("button"),this.button.className="content-fab-button",this.button.title="Open Journal",this.button.innerHTML='\n      <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">\n        <path d="M19 3H5C3.9 3 3 3.9 3 5v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>\n      </svg>\n    ',this.indicator=document.createElement("div"),this.indicator.className="content-fab-indicator",this.indicator.style.display="none",this.button.addEventListener("click",(()=>{this.contentManager.toggleUI()})),this.element.appendChild(this.button),this.element.appendChild(this.indicator),this.parentContainer.appendChild(this.element),this.hide()}setupEventListeners(){this.eventBus.on("content-indicator",(e=>{this.updateIndicator(e.hasNew)})),this.eventBus.on("content-ui-open",(()=>{this.updateIndicator(!1)})),this.eventBus.on("gameState",(e=>{const t=e.state===r.PLAYING;this.setVisible(t)}))}updateIndicator(e){this.hasNewContent=e,this.indicator.style.display=e?"block":"none",this.button.classList.toggle("has-new-content",e)}show(){this.element.style.display="block"}hide(){this.element.style.display="none"}setVisible(e){e?this.show():this.hide()}dispose(){this.element.remove()}}class z{constructor(){this.activeTab=null,this.contentManager=$.getInstance(),this.eventBus=h.l.getInstance(),this.createElement(),this.setupEventListeners();const e=u.getInstance();e?e.registerUILayer("content-overlay",this.element):console.error("ContentOverlay: UIManager not available")}createElement(){this.element=document.createElement("div"),this.element.className="content-overlay",this.element.style.display="none",this.modal=document.createElement("div"),this.modal.className="content-overlay-modal";const e=document.createElement("div");e.className="content-overlay-header";const t=document.createElement("h2");t.className="content-overlay-title",t.textContent="Journal",this.closeButton=document.createElement("button"),this.closeButton.className="content-overlay-close",this.closeButton.innerHTML="&times;",this.closeButton.title="Close",this.closeButton.addEventListener("click",(()=>{this.contentManager.closeUI()})),e.appendChild(t),e.appendChild(this.closeButton),this.tabContainer=document.createElement("div"),this.tabContainer.className="content-overlay-tabs",this.contentContainer=document.createElement("div"),this.contentContainer.className="content-overlay-content",this.modal.appendChild(e),this.modal.appendChild(this.tabContainer),this.modal.appendChild(this.contentContainer),this.element.appendChild(this.modal),this.element.addEventListener("mousedown",(e=>{e.target===this.element&&this.contentManager.closeUI()})),document.addEventListener("keydown",(e=>{"Escape"===e.key&&this.isVisible()&&this.contentManager.closeUI()}))}setupEventListeners(){this.eventBus.on("content-ui-open",(e=>{this.show(),e.tab?this.setActiveTab(e.tab):this.refreshTabs()})),this.eventBus.on("content-ui-close",(()=>{this.hide()})),this.eventBus.on("content-tab-change",(e=>{this.setActiveTab(e.tab)}))}refreshTabs(){this.tabContainer.innerHTML="";const e=this.contentManager.getRegisteredContentTypes();0!==e.length?(e.forEach((e=>{const t=document.createElement("button");t.className="content-overlay-tab",t.textContent=this.formatTabName(e),t.dataset.contentType=e;const i=this.contentManager.getContentHandler(e);i?.hasNewContent()&&t.classList.add("has-new-content"),t.addEventListener("click",(()=>{this.contentManager.setActiveTab(e)})),this.tabContainer.appendChild(t)})),!this.activeTab&&e.length>0&&this.setActiveTab(e[0])):this.tabContainer.innerHTML='<div class="content-overlay-no-tabs">No content types registered</div>'}setActiveTab(e){this.activeTab=e,this.tabContainer.querySelectorAll(".content-overlay-tab").forEach((t=>{const i=t.dataset.contentType===e;t.classList.toggle("active",i),i&&t.classList.remove("has-new-content")})),this.renderTabContent(e)}renderTabContent(e){this.contentContainer.innerHTML="";const t=this.contentManager.getContentHandler(e);if(!t)return void(this.contentContainer.innerHTML=`<div class="content-overlay-empty">No handler for ${e}</div>`);const i=t.getAllItems();0!==i.length?[...i].sort(((e,t)=>{const i={new:0,"in-progress":1,completed:2,discovered:3},s=i[e.status]-i[t.status];return 0!==s?s:t.timestamp-e.timestamp})).forEach((e=>{const t=this.createItemElement(e);this.contentContainer.appendChild(t)})):this.contentContainer.innerHTML=`<div class="content-overlay-empty">No ${e} items yet</div>`}createItemElement(e){const t=document.createElement("div");t.className=`content-overlay-item content-overlay-item--${e.status}`;const i=document.createElement("div");i.className="content-overlay-item-header";const s=document.createElement("h3");s.className="content-overlay-item-title",s.textContent=e.title;const n=document.createElement("span");if(n.className=`content-overlay-item-status content-overlay-item-status--${e.status}`,n.textContent=e.status.replace("-"," ").toUpperCase(),i.appendChild(s),i.appendChild(n),t.appendChild(i),e.description){const i=document.createElement("div");i.className="content-overlay-item-description",i.textContent=e.description,t.appendChild(i)}if(e.category||e.tags?.length){const i=document.createElement("div");if(i.className="content-overlay-item-meta",e.category){const t=document.createElement("span");t.className="content-overlay-item-category",t.textContent=e.category,i.appendChild(t)}e.tags?.length&&e.tags.forEach((e=>{const t=document.createElement("span");t.className="content-overlay-item-tag",t.textContent=`#${e}`,i.appendChild(t)})),t.appendChild(i)}return t}formatTabName(e){return e.replace(/([A-Z])/g," $1").replace(/^./,(e=>e.toUpperCase())).trim()}show(){this.element.style.display="flex",this.refreshTabs(),requestAnimationFrame((()=>{this.modal.classList.add("slide-up")}))}hide(){this.modal.classList.remove("slide-up"),setTimeout((()=>{this.element.style.display="none"}),300)}isVisible(){return"none"!==this.element.style.display}dispose(){this.element.remove()}}class F{constructor(e,t){this.hasActiveGame=!1,this.config=e,this.container=t,this.canvas=document.createElement("canvas"),this.ctx=this.canvas.getContext("2d"),this.currentScene=null,this.resourceManager=new n(e),this.inputManager=new a,this.camera=new o(e),this.isRunning=!1,this.lastFrameTime=0,this.isometricConverter=new c.K(e.tileSize||32),this.dialogManager=d.getInstance(),this.eventBus=h.l.getInstance(),this.currentState=r.START_SCREEN,this.sceneManager=new A(this.resourceManager,e,this.camera),this.uiManager=u.getInstance(e,this.container),this.contentManager=$.getInstance(),this.questTracker=new R,this.contentFAB=new G(this.container),this.contentOverlay=new z,this.startScreen=new g({title:e.title||"Isometric Game",background:e.startScreenBackground,music:e.startScreenMusic,showSettings:!0,showCredits:!0}),this.loadingScreen=new S,S.addStyles(),this.inGameMenu=v.getInstance(this.container),v.addStyles(),this.canvasUIManager=new b(this.canvas),this.creditsOverlay=new m((()=>{this.eventBus.emit("gameState",{type:"gameState",state:r.START_SCREEN})})),this.settingsOverlay=new y(this.config,(e=>{Object.assign(this.config,e),(e.width||e.height)&&this.updateCanvasSize()}),(()=>{this.eventBus.emit("gameState",{type:"gameState",state:r.START_SCREEN})})),this.dialogManager.setCamera(this.camera),this.dialogManager.setIsometricConverter(this.isometricConverter),this.container.appendChild(this.canvas),this.updateCanvasSize(),this.eventBus.on("gameState",(e=>{e.state&&e.state!==this.currentState&&this.handleGameStateChange(e.state)})),this.eventBus.on("displayMessage",(e=>{this.displayScriptMessage(e.text,e.duration||3e3,e.position||"center")})),window.addEventListener("resize",(()=>{this.updateCanvasSize()})),this.canvas.addEventListener("click",(async e=>{if(!this.currentScene||this.currentState!==r.PLAYING)return;const t=this.canvas.getBoundingClientRect(),i=e.clientX-t.left,s=e.clientY-t.top,n=(this.camera.screenToWorld({x:i,y:s}),Array.from(this.currentScene.getElements().values()));n.reverse();for(const e of n){if(!e.isInteractable())continue;const t=e.isometricConverter.tileToScreen(e.getPosition().x,e.getPosition().y),n=this.camera.worldToScreen(t),a=e.getSprite();if(!a)continue;const o=this.camera.getZoom(),r=a.width*o,c=a.height*o,h=n.x-r/2,l=n.y-c,d=n.x+r/2,u=n.y;if(i>=h&&i<=d&&s>=l&&s<=u){if(e.getClickSfx()){const t=`${e.getId()}_click`;this.audioSystem.play(t).catch((t=>{console.warn(`Failed to play click SFX for element ${e.getId()}:`,t)}))}const t=e.getProperty("dialog");if(t){const i={x:e.getPosition().x,y:e.getPosition().y,spriteHeight:a.height};this.dialogManager.showDialog(e.getId(),t,{},i)}await e.triggerInteraction();break}}})),this.sceneTransitionManager=x.getInstance(),this.eventBus.on("sceneConnection",(e=>{this.handleSceneTransition(e)})),this.eventBus.on("sceneTransition",(e=>{"changeScene"===e.action&&this.switchToPreloadedScene(e.toScene)})),this.audioSystem=f.g.getInstance(),this.scriptEngine=I.w.getInstance(),this.scriptEngine.setGameReference(this),this.muteButton=C.getInstance(this.container),this.devToolsManager=P.getInstance()}displayScriptMessage(e,t,i){const s=document.createElement("div");switch(s.textContent=e,s.style.cssText="\n      position: fixed;\n      left: 50%;\n      transform: translateX(-50%);\n      background: rgba(0, 0, 0, 0.8);\n      color: white;\n      padding: 10px 20px;\n      border-radius: 5px;\n      font-size: 16px;\n      z-index: 10000;\n      pointer-events: none;\n      max-width: 400px;\n      text-align: center;\n      font-family: 'Arial', sans-serif;\n      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);\n    ",i){case"top":s.style.top="80px";break;case"bottom":s.style.bottom="80px";break;default:s.style.top="50%",s.style.transform="translateX(-50%) translateY(-50%)"}document.body.appendChild(s),s.style.opacity="0",s.style.transition="opacity 0.3s ease-in-out",requestAnimationFrame((()=>{s.style.opacity="1"})),setTimeout((()=>{s.style.opacity="0",setTimeout((()=>{document.body.contains(s)&&document.body.removeChild(s)}),300)}),t)}async initialize(){await this.sceneManager.initialize(),this.sceneTransitionManager.initialize(this.canvas),await this.devToolsManager.initialize(this.canvas,this.sceneManager,this.config,this.camera,this.inputManager),this.initializeContentSystem(),this.config.debugSkipMenu?await this.handleGameStateChange(r.LOADING):await this.handleGameStateChange(r.START_SCREEN),await this.initializeAudio()}async initializeAudio(){try{await this.audioSystem.initialize(),this.config.audio&&(void 0!==this.config.audio.masterVolume&&this.audioSystem.setVolume("master",this.config.audio.masterVolume),void 0!==this.config.audio.musicVolume&&this.audioSystem.setVolume("music",this.config.audio.musicVolume),void 0!==this.config.audio.sfxVolume&&this.audioSystem.setVolume("sfx",this.config.audio.sfxVolume));const e=this.resourceManager.getAssetUrl("let_us_get_to_work_2.mp3");if(e){const t=await this.audioSystem.loadTrack("background",e,"music");t.success||console.warn("Failed to load background music:",t.error)}}catch(e){console.error("Failed to initialize audio system:",e)}}initializeContentSystem(){this.contentManager.registerContentType(this.questTracker),console.log("ðŸ“‹ Content system initialized with quest tracking")}async handleGameStateChange(e,t){console.log(`State transition: ${this.currentState} -> ${e}`,t||"");const i=this.hasActiveGame;if(e===r.LOADING||e===r.PLAYING?this.hasActiveGame=!0:e===r.START_SCREEN&&(this.currentScene||(this.hasActiveGame=!1)),i!==this.hasActiveGame&&this.eventBus.emit("gameActiveState",{active:this.hasActiveGame}),!this.isValidStateTransition(this.currentState,e))return void console.warn(`Invalid state transition from ${this.currentState} to ${e}`);const s=this.currentState;switch(this.currentState=e,await this.cleanupState(s),e){case r.START_SCREEN:this.uiManager.showLayer("start-screen"),this.dialogManager.hideDialog(),this.stop(),this.inGameMenu.hide(),this.muteButton.hide();break;case r.LOADING:this.uiManager.hideAllLayers(),this.uiManager.showLayer("loading-screen"),this.dialogManager.hideDialog(),this.inGameMenu.hide(),this.muteButton.hide();try{this.loadingScreen.updateProgress(0);const e=this.sceneManager.getDefaultSceneName();this.currentScene=await this.sceneManager.loadScene(e),this.devToolsManager.setCurrentScene(e,this.currentScene);const t=this.currentScene.getConfig();if(t.initialCameraTile){const e=this.isometricConverter.tileToScreen(t.initialCameraTile.x,t.initialCameraTile.y);this.camera.centerOn(e,{width:this.config.width,height:this.config.height},!1)}void 0!==t.initialZoom&&this.camera.setZoom(t.initialZoom),this.loadingScreen.updateProgress(1),setTimeout((async()=>{await this.handleGameStateChange(r.PLAYING)}),100)}catch(e){console.error("Failed to load scene:",e),await this.handleGameStateChange(r.START_SCREEN)}break;case r.PLAYING:if(!this.currentScene)return console.error("Cannot transition to PLAYING state without a loaded scene"),void await this.handleGameStateChange(r.START_SCREEN);this.uiManager.hideAllLayers(),this.start(),this.inGameMenu.show(),this.muteButton.show();break;case r.PAUSED:this.stop();break;case r.DIALOG:if(!t?.dialog)return console.error("Dialog state requires dialog data"),void await this.handleGameStateChange(s);this.dialogManager.showDialog(t.dialog.id,t.dialog.content,t.dialog.options,t.dialog.position);break;case r.MENU:"settings"===t?.menu?(this.uiManager.showLayer("settings-overlay"),this.settingsOverlay.show()):"credits"===t?.menu?this.uiManager.showLayer("credits-overlay"):(console.error("Invalid menu type:",t?.menu),await this.handleGameStateChange(s));case r.TRANSITIONING:}console.log(`State transition complete: ${e}`),this.eventBus.emit("gameState",{type:"gameState",state:e})}isValidStateTransition(e,t){const i={[r.START_SCREEN]:[r.LOADING,r.MENU,r.START_SCREEN,r.PLAYING],[r.LOADING]:[r.PLAYING,r.START_SCREEN],[r.PLAYING]:[r.PAUSED,r.DIALOG,r.MENU,r.START_SCREEN,r.TRANSITIONING],[r.PAUSED]:[r.PLAYING,r.MENU,r.START_SCREEN],[r.DIALOG]:[r.PLAYING,r.PAUSED,r.START_SCREEN],[r.MENU]:[r.PLAYING,r.START_SCREEN,r.MENU],[r.TRANSITIONING]:[r.PLAYING,r.START_SCREEN]};return!(e!==t||![r.MENU,r.START_SCREEN].includes(e))||(i[e]?.includes(t)??!1)}async cleanupState(e){switch(console.log(`Cleaning up state: ${e}`),e){case r.PLAYING:break;case r.DIALOG:this.dialogManager.hideDialog();break;case r.MENU:this.settingsOverlay.hide(),this.creditsOverlay.hide()}}start(){this.isRunning||(this.isRunning=!0,this.lastFrameTime=performance.now(),requestAnimationFrame(this.gameLoop.bind(this)))}stop(){this.isRunning=!1}gameLoop(e){if(!this.isRunning)return;const t=(e-this.lastFrameTime)/1e3;this.lastFrameTime=e,this.update(t),this.render(),requestAnimationFrame(this.gameLoop.bind(this))}update(e){this.currentScene&&this.currentScene.update(e),this.canvasUIManager.update(e);const t=this.inputManager.getMovementDirection();if(0!==t.x||0!==t.y){const i=this.config.keyboardSpeed||15,s=t.x*i*e*100,n=t.y*i*e*100;this.camera.moveBy({x:s,y:n})}const i=this.inputManager.getDragDelta();if(0!==i.x||0!==i.y){const e=this.config.mouseSpeed||2,t=-i.x*e,s=-i.y*e;this.camera.moveBy({x:t,y:s})}const s=this.inputManager.getWheelDelta();if(0!==s){const e=this.camera.getZoom()+s;this.camera.setZoom(e)}this.camera.update(e),this.dialogManager.update(e),this.devToolsManager.update()}render(){this.currentScene&&this.currentScene.render(this.ctx),this.dialogManager.render(this.ctx),this.canvasUIManager.render(),this.devToolsManager&&this.devToolsManager.render(this.ctx)}async loadScene(e){try{this.currentScene=await this.sceneManager.loadScene(e),this.devToolsManager.setCurrentScene(e,this.currentScene);const t=this.currentScene.getConfig();if(t.cameraBounds){const e=this.currentScene.calculateCameraBounds(t.cameraBounds);this.camera.setBounds(e)}else this.camera.setBounds({minX:-1/0,minY:-1/0,maxX:1/0,maxY:1/0,width:1/0,height:1/0});if(t.initialCameraTile){const e=this.isometricConverter.tileToScreen(t.initialCameraTile.x,t.initialCameraTile.y);this.camera.centerOn(e,{width:this.config.width,height:this.config.height},!1)}void 0!==t.initialZoom&&this.camera.setZoom(t.initialZoom)}catch(e){throw console.error("Failed to load scene:",e),e}}getCanvas(){return this.canvas}getContext(){return this.ctx}getCurrentScene(){return this.currentScene}getResourceManager(){return this.resourceManager}getInputManager(){return this.inputManager}getCamera(){return this.camera}getIsometricConverter(){return this.isometricConverter}getConfig(){return this.config}isGameRunning(){return this.isRunning}updateCanvasSize(){const e=this.config.width,t=this.config.height,i=window.devicePixelRatio||1;this.container.style.width=e+"px",this.container.style.height=t+"px",this.canvas.width=e*i,this.canvas.height=t*i,this.canvas.style.width=e+"px",this.canvas.style.height=t+"px",this.ctx.setTransform(1,0,0,1,0,0),this.ctx.scale(i,i),this.ctx.clearRect(0,0,e,t),this.camera.setViewportSize(e,t),this.render()}async handleSceneTransition(e){if(!this.currentScene)return;const{fromScene:t,toScene:i,transitionType:s}=e,n=s||p.FADE;console.log(`ðŸŽ¬ Preloading scene "${i}" before transition...`);try{await this.sceneManager.loadScene(i),console.log(`âœ… Scene "${i}" preloaded successfully, starting transition...`),this.sceneTransitionManager.startTransition(t,i,{type:n},(()=>{console.log(`ðŸŽ¬ Transition from ${t} to ${i} complete`)}))}catch(e){console.error(`âŒ Failed to preload scene "${i}":`,e),this.sceneTransitionManager.startTransition(t,i,{type:n},(()=>{console.log(`Transition from ${t} to ${i} complete`)}))}}switchToPreloadedScene(e){try{const t=this.sceneManager.getCachedScene(e);t?(console.log(`ðŸŽ¬ Switching to preloaded scene: ${e}`),this.currentScene=t,this.initializeSceneCamera(t),this.devToolsManager.setCurrentScene(e,t),console.log(`âœ… Successfully switched to scene: ${e}`)):(console.warn(`âš ï¸ Scene ${e} not found in cache, falling back to full load`),this.loadScene(e))}catch(t){console.error(`âŒ Error switching to preloaded scene ${e}:`,t),this.loadScene(e)}}initializeSceneCamera(e){const t=e.getConfig();if(t.cameraBounds){const i=e.calculateCameraBounds(t.cameraBounds);this.camera.setBounds(i)}else this.camera.setBounds({minX:-1/0,minY:-1/0,maxX:1/0,maxY:1/0,width:1/0,height:1/0});if(t.initialCameraTile){const e=this.isometricConverter.tileToScreen(t.initialCameraTile.x,t.initialCameraTile.y);this.camera.centerOn(e,{width:this.config.width,height:this.config.height},!1)}void 0!==t.initialZoom&&this.camera.setZoom(t.initialZoom)}isGameInProgress(){return this.hasActiveGame}centerCameraOnElement(e,t=!1,i){if(!this.currentScene)return void console.warn("Cannot center camera - no scene loaded");const s=this.currentScene.getElement(e);if(!s)return void console.warn(`Element ${e} not found in current scene`);const n=s.getPosition(),a=this.isometricConverter.tileToScreen(n.x,n.y);void 0!==i&&this.camera.setZoom(i),this.camera.centerOn(a,{width:this.config.width,height:this.config.height},t)}dispose(){this.stop(),this.inputManager.dispose(),this.resourceManager.dispose(),this.canvas.parentNode&&this.canvas.parentNode.removeChild(this.canvas),this.currentScene=null}}function O(){document.querySelectorAll(".iso-game-container").forEach((e=>{const t=e,i=t.dataset.scene||"ben",s=t.dataset.background||"default",n=window.ISO_Game_Config||{},a=N.getWordPressConfig({width:t.offsetWidth,height:t.offsetHeight,defaultScene:i,startScreenBackground:s,assetsPath:n.assetsPath,debug:n.debug,cacheScenes:n.cacheScenes,...n}),o=new F(a,t);o.initialize().then((()=>{o.start()})),t.gameInstance=o}))}function U(){document.querySelectorAll(".iso-game-container").forEach((e=>{const t=e,i=t.gameInstance;i&&(i.dispose(),t.gameInstance=null)}))}document.addEventListener("DOMContentLoaded",O),document.addEventListener("ihp-cleanup",U),window.initializeGames=O,window.cleanupGames=U;const _={initializeGames:O,cleanupGames:U};window.IsoGameEngine=s.default})();